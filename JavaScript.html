<script>
    // ===================================================================================
    // GLOBAL VARIABLES & APP INITIALIZATION
    // ===================================================================================
    let appData = { transactions: [], categories: [], budgets: {}, accounts: [], taxData: {} };
    let charts = {};
    let historyDataTable;
    let isGoogleSheetsMode = false;
    let transactionModalInstance, accountModalInstance, transferModalInstance, categoryModalInstance;

    $(document).ready(function() { initializeApp(); });

    function initializeApp() {
        showLoading();
        setupEventHandlers();
        setupThemeSwitcher();
        // ** REFACTOR: ไม่มีการเรียกใช้ PIN **
        startDataLoading(); // เริ่มโหลดข้อมูลทันที
    }

    // ===================================================================================
    // STARTUP, DATA LOADING & UI INITIALIZATION
    // ===================================================================================
    // ** REFACTOR: ลบฟังก์ชัน checkPIN ออก **

    function startDataLoading() {
        // $('#pinOverlay').hide(); // ไม่จำเป็นต้องซ่อนอีกต่อไป
        showLoading();
        updateLoadingStatus('กำลังเชื่อมต่อ...');
        google.script.run.withSuccessHandler(() => {
          isGoogleSheetsMode = true;
          updateLoadingStatus('กำลังเตรียมข้อมูล...');
          initializeSheets();
        }).withFailureHandler(err => {
          console.error('Connection Error:', err);
          fallbackToLocalMode();
        }).testConnection();
    }

    function initializeSheets() {
      google.script.run.withSuccessHandler(() => {
        updateLoadingStatus('กำลังโหลดข้อมูล...');
        loadDataFromSource();
      }).withFailureHandler(err => {
        console.error('Sheet Init Error:', err);
        fallbackToLocalMode();
      }).initializeSheets();
    }
    
    function fallbackToLocalMode() {
        updateLoadingStatus('เปลี่ยนเป็นโหมดออฟไลน์');
        isGoogleSheetsMode = false;
        setTimeout(() => loadDataFromSource(), 1000);
    }
    
    function loadDataFromSource() {
        if (isGoogleSheetsMode) {
            google.script.run
                .withSuccessHandler(data => {
                    if (data && typeof data === 'object') {
                        appData.transactions = Array.isArray(data.transactions) ? data.transactions.map(t => ({...t, date: new Date(t.date).toISOString().split('T')[0]})) : [];
                        appData.categories = Array.isArray(data.categories) ? data.categories : [];
                        appData.budgets = (data.budgets && typeof data.budgets === 'object') ? data.budgets : {};
                        appData.accounts = Array.isArray(data.accounts) ? data.accounts : [];
                        appData.taxData = (data.taxData && typeof data.taxData === 'object') ? data.taxData : {};
                    }
                    if (appData.categories.length === 0) createDefaultCategories();
                    initializeUI();
                })
                .withFailureHandler(err => {
                    console.error('Data Loading Error:', err);
                    fallbackToLocalMode();
                })
                .getAppData();
        } else {
            loadData();
            if (!appData.transactions || appData.transactions.length === 0) createMockData();
            initializeUI();
        }
    }

    function initializeUI() {
        updateLoadingStatus('กำลังเตรียมหน้าจอ...');
        setTimeout(() => {
            transactionModalInstance = new bootstrap.Modal(document.getElementById('transactionModal'));
            accountModalInstance = new bootstrap.Modal(document.getElementById('accountModal'));
            transferModalInstance = new bootstrap.Modal(document.getElementById('transferModal'));
            categoryModalInstance = new bootstrap.Modal(document.getElementById('categoryModal'));

            updateCurrentMonth();
            populateDashboardMonths();
            populateHistoryMonths(); // ** REFACTOR: เพิ่มการสร้างตัวเลือกเดือนสำหรับหน้าประวัติ **
            addTransactionCard(); 
            updateDashboard(); 
            loadCategories();
            loadBudgetForm();
            loadTransactionHistory();
            populateTaxYear();
            loadTaxData();
            
            showConnectionStatus(isGoogleSheetsMode);
            hideLoading();
        }, 500);
    }
    
    // ===================================================================================
    // LOCAL DATA & MOCK DATA
    // ===================================================================================
    function loadData() {
        const savedData = localStorage.getItem('financeApp');
        if (savedData) appData = JSON.parse(savedData);
        else createMockData();
    }
    
    function createDefaultCategories() {
        appData.categories = [
            { id: 1, name: "เงินเดือน", type: "income", color: "#4caf50" },
            { id: 2, name: "รายได้เสริม", type: "income", color: "#8bc34a" },
            { id: 3, name: "อาหาร", type: "expense", color: "#ff9800" },
            { id: 4, name: "เดินทาง", type: "expense", color: "#f44336" },
        ];
    }
    
    function createMockData() {
        appData = {
            transactions: [],
            categories: [
                { id: 1, name: "เงินเดือน", type: "income", color: "#4caf50" },
                { id: 3, name: "อาหาร", type: "expense", color: "#ff9800" },
            ],
            budgets: {},
            accounts: [
              { id: 1, name: "เงินสด", type: "Cash", initialBalance: 1000, icon: "fa-wallet"},
              { id: 2, name: "ธนาคาร", type: "Savings", initialBalance: 5000, icon: "fa-landmark"}
            ],
            taxData: {}
        };
    }

    function saveData() {
        localStorage.setItem('financeApp', JSON.stringify(appData));
    }

    // ===================================================================================
    // EVENT HANDLERS
    // ===================================================================================
    function setupEventHandlers() {
        $('#transactionForm, #categoryForm, #budgetForm, #accountForm, #transferForm, #taxForm').on('submit', e => e.preventDefault());
        $('#transactionForm').on('submit', saveTransactions);
        $('#categoryForm').on('submit', addCategory);
        $('#budgetForm').on('submit', saveBudget);
        $('#accountForm').on('submit', saveAccount);
        $('#transferForm').on('submit', saveTransfer);
        $('#taxForm').on('submit', saveTaxData);
        $('#saveTransactionsBtn').on('click', () => $('#transactionForm').submit());
        $('#filterCategory, #filterStartDate, #filterEndDate').on('change', loadTransactionHistory);
        $('#resetFilter').on('click', () => { $('#filterCategory, #filterStartDate, #filterEndDate').val(''); loadTransactionHistory(); });
        $('#transactionModal').on('hidden.bs.modal', () => { $('#transactionCards').html(''); addTransactionCard(); });
        $('#taxTotalIncome, #taxDeductibleExpenses').on('input', calculateTax);
        $('#accountModal').on('show.bs.modal', () => $('#accountModalTitle').html('<i class="fas fa-landmark me-2"></i>เพิ่มบัญชีใหม่'));
        $('#accountModal').on('hidden.bs.modal', () => { $('#accountForm')[0].reset(); $('#accountId').val(''); });
    }

    // ===================================================================================
    // THEME, PIN, & NAVIGATION
    // ===================================================================================
    function setupThemeSwitcher() {
        const switcher = $('#theme-switcher');
        const body = $('body');
        const updateThemeIcon = theme => switcher.find('i').toggleClass('fa-moon', theme === 'light').toggleClass('fa-sun', theme === 'dark');
        const currentTheme = localStorage.getItem('appTheme') || 'light';
        body.attr('data-theme', currentTheme);
        updateThemeIcon(currentTheme);
        switcher.on('click', () => {
            const newTheme = body.attr('data-theme') === 'light' ? 'dark' : 'light';
            body.attr('data-theme', newTheme);
            localStorage.setItem('appTheme', newTheme);
            updateThemeIcon(newTheme);
            updateDashboard();
        });
    }

    // ** REFACTOR: ลบฟังก์ชันเกี่ยวกับ PIN ทั้งหมด **
    // - setupPinInputLogic()
    // - verifyPIN()
    // - setupPIN()
    // - removePIN()

    function showSection(sectionName) {
        $('.section').removeClass('active');
        $('#' + sectionName).addClass('active');
        $('.nav-link').removeClass('active'); 
        $(`a[onclick="showSection('${sectionName}')"]`).addClass('active'); 
        
        const sectionLoaders = { dashboard: updateDashboard, transactions: loadTransactionHistory, categories: loadCategories, budget: loadBudgetForm, tax: loadTaxData };
        if (sectionLoaders[sectionName]) sectionLoaders[sectionName]();
    }

    // ===================================================================================
    // ACCOUNTS MANAGEMENT
    // ===================================================================================
    function loadAccounts() {
        const dashboardAccountList = $('#dashboardAccountList');
        const transferFrom = $('#transferFrom');
        const transferTo = $('#transferTo');
        dashboardAccountList.empty();
        transferFrom.empty().append('<option value="">เลือกบัญชี</option>');
        transferTo.empty().append('<option value="">เลือกบัญชี</option>');

        if (appData.accounts.length === 0) {
            dashboardAccountList.html('<p class="text-muted text-center col-12">เริ่มต้นด้วยการ "เพิ่มบัญชี" ของคุณ</p>');
        }

        appData.accounts.forEach(account => {
            const currentBalance = appData.transactions.reduce((balance, t) => {
                if (t.type === 'income' && String(t.accountId) === String(account.id)) {
                    return balance + t.amount;
                }
                if (t.type === 'expense' && String(t.accountId) === String(account.id)) {
                    return balance - t.amount;
                }
                if (t.type === 'transfer' && String(t.to) === String(account.id)) {
                    return balance + t.amount;
                }
                if (t.type === 'transfer' && String(t.from) === String(account.id)) {
                    return balance - t.amount;
                }
                return balance;
            }, account.initialBalance);

    const card = `
        <div class="col-md-4 mb-3">
            <div class="account-card-small">
                <div class="d-flex justify-content-between align-items-center">
                   <div>
                     <h6 class="mb-0">${account.name}</h6>
                     <small class="text-muted">${account.type}</small>
                   </div>
                   <div>
                       <button class="btn btn-sm btn-outline-info me-1" onclick="openEditAccountModal(${account.id})"><i class="fas fa-pencil-alt"></i></button>
                       <button class="btn btn-sm btn-outline-danger" onclick="deleteAccount(${account.id})"><i class="fas fa-trash"></i></button>
                   </div>
                </div>
                <p class="balance mt-2 mb-0">฿${currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
            </div>
        </div>`;
            dashboardAccountList.append(card);

            transferFrom.append(`<option value="${account.id}">${account.name}</option>`);
            transferTo.append(`<option value="${account.id}">${account.name}</option>`);
        });

        const accountOptions = appData.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');
        $('select[name="accountId[]"]').html('<option value="">เลือกบัญชี</option>' + accountOptions);
    }

    function openEditAccountModal(accountId) {
        const account = appData.accounts.find(acc => acc.id === accountId);
        if (!account) return;

        $('#accountModalTitle').html('<i class="fas fa-pencil-alt me-2"></i>แก้ไขบัญชี');
        
        $('#accountId').val(account.id);
        $('#accountName').val(account.name);
        $('#accountType').val(account.type);
        $('#initialBalance').val(account.initialBalance);

        accountModalInstance.show();
    }

    function saveAccount(e) {
        e.preventDefault();
        
        const submitButton = $('#saveAccountBtn');
        const originalButtonHtml = submitButton.html(); 
        submitButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>กำลังบันทึก...');

        const accountId = $('#accountId').val();

        const accountData = {
            id: accountId ? parseInt(accountId) : Date.now(),
            name: $('#accountName').val(),
            type: $('#accountType').val(),
            initialBalance: parseFloat($('#initialBalance').val()),
        };

        if (!accountData.name || !accountData.type) {
             Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อและประเภทบัญชี', 'warning');
             submitButton.prop('disabled', false).html(originalButtonHtml);
             return;
        }
        
        const isEditing = !!accountId;
        const successMessage = isEditing ? 'แก้ไขบัญชีเรียบร้อยแล้ว' : 'เพิ่มบัญชีเรียบร้อยแล้ว';

        const handleSuccess = () => {
            if (isEditing) {
                const index = appData.accounts.findIndex(acc => acc.id === accountData.id);
                if (index !== -1) appData.accounts[index] = { ...appData.accounts[index], ...accountData };
            } else {
                if (!appData.accounts.some(acc => acc.id === accountData.id)) {
                    appData.accounts.push({ ...accountData, icon: 'fa-wallet' });
                }
            }
            $('#accountForm')[0].reset();
            $('#accountId').val('');
            loadAccounts();
            submitButton.prop('disabled', false).html(originalButtonHtml);
        };

        if (isGoogleSheetsMode) {
            const apiCall = isEditing ? google.script.run.updateAccount(accountData) : google.script.run.saveAccount(accountData);
            apiCall
                .withSuccessHandler(response => {
                    Swal.fire('สำเร็จ!', successMessage, 'success').then(() => accountModalInstance.hide());
                    handleSuccess();
                })
                .withFailureHandler(err => {
                    Swal.fire('ผิดพลาด', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                    submitButton.prop('disabled', false).html(originalButtonHtml);
                });
        } else {
            saveData();
            Swal.fire('สำเร็จ!', successMessage + ' (โหมดออฟไลน์)', 'success').then(() => accountModalInstance.hide());
            handleSuccess();
        }
    }
    
    function deleteAccount(accountId) {
        const account = appData.accounts.find(acc => acc.id === accountId);
        if (!account) return;

        const currentBalance = appData.transactions.reduce((balance, t) => {
            if (t.type === 'income' && String(t.accountId) === String(account.id)) return balance + t.amount;
            if (t.type === 'expense' && String(t.accountId) === String(account.id)) return balance - t.amount;
            if (t.type === 'transfer' && String(t.to) === String(account.id)) return balance + t.amount;
            if (t.type === 'transfer' && String(t.from) === String(account.id)) return balance - t.amount;
            return balance;
        }, account.initialBalance);

        if (Math.abs(currentBalance) > 0.001) { 
            Swal.fire({
                icon: 'error',
                title: 'ไม่สามารถลบได้',
                text: `บัญชียังมียอดเงินคงเหลืออยู่ ${currentBalance.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})} บาท กรุณาโอนย้ายเงินออกก่อน`
            });
            return;
        }

        const accountIdStr = String(accountId);
        const hasHistory = appData.transactions.some(t => 
            String(t.accountId) === accountIdStr || 
            String(t.from) === accountIdStr || 
            String(t.to) === accountIdStr
        );

        const confirmationConfig = {
            title: 'ยืนยันการลบ',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ลบ',
            cancelButtonText: 'ยกเลิก',
            confirmButtonColor: '#d33',
        };

        if (hasHistory) {
            confirmationConfig.text = "ยอดเงินในบัญชีเป็น 0 แล้ว แต่บัญชียังมีประวัติการทำรายการอยู่ หากลบ บัญชีจะหายไปจากระบบ แต่ประวัติเก่าๆ จะยังคงอยู่ (ไม่สามารถแก้ไขได้อีก) ยืนยันที่จะลบหรือไม่?";
        } else {
            confirmationConfig.text = "คุณต้องการลบบัญชีนี้ใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้";
        }

        Swal.fire(confirmationConfig).then((result) => {
            if (!result.isConfirmed) return;
            
            Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            appData.accounts = appData.accounts.filter(acc => acc.id !== accountId);

            if (isGoogleSheetsMode) {
                google.script.run
                    .withSuccessHandler(response => {
                        loadAccounts();
                        Swal.fire('สำเร็จ!', 'ลบบัญชีเรียบร้อยแล้ว', 'success');
                    })
                    .withFailureHandler(error => {
                        Swal.fire('ข้อผิดพลาด', 'ไม่สามารถลบบัญชีได้', 'error');
                    })
                    .deleteAccount(accountId);
            } else {
                saveData();
                loadAccounts();
                Swal.fire('สำเร็จ!', 'ลบบัญชีเรียบร้อยแล้ว (โหมดออฟไลน์)', 'success');
            }
        });
    }

    // ===================================================================================
    // TRANSFERS MANAGEMENT
    // ===================================================================================
    function saveTransfer(e) {
        e.preventDefault();
        
        const submitButton = $('#saveTransferBtn');
        const originalButtonHtml = submitButton.html();

        const fromId = $('#transferFrom').val();
        const toId = $('#transferTo').val();

        if(!fromId || !toId || fromId === toId) {
            Swal.fire('ผิดพลาด', 'กรุณาเลือกบัญชีต้นทางและปลายทางที่แตกต่างกัน', 'warning');
            return;
        }

        submitButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>กำลังโอน...');
        const resetButton = () => submitButton.prop('disabled', false).html(originalButtonHtml);

        const newTransfer = {
            id: Date.now(),
            date: $('#transferDate').val() || new Date().toISOString().split('T')[0],
            type: 'transfer',
            from: fromId,
            to: toId,
            amount: parseFloat($('#transferAmount').val()),
            description: $('#transferDescription').val(),
            category: null,
            accountId: null
        };
        
        appData.transactions.push(newTransfer);

        const handleSuccess = () => {
            $('#transferForm')[0].reset();
            updateDashboard();
            loadTransactionHistory();
            resetButton();
            transferModalInstance.hide();
        };

        if (isGoogleSheetsMode) {
            google.script.run
                .withSuccessHandler(response => {
                    Swal.fire('สำเร็จ!', 'บันทึกการโอนเงินเรียบร้อยแล้ว', 'success');
                    handleSuccess();
                })
                .withFailureHandler(err => {
                    appData.transactions = appData.transactions.filter(t => t.id !== newTransfer.id);
                    Swal.fire('ผิดพลาด', 'ไม่สามารถบันทึกได้', 'error');
                    resetButton();
                })
                .saveMultipleTransactions([newTransfer]);
        } else {
            saveData();
            Swal.fire('สำเร็จ!', 'บันทึกการโอนเงินเรียบร้อยแล้ว', 'success');
            handleSuccess();
        }
    }

    // ===================================================================================
    // CATEGORY MANAGEMENT
    // ===================================================================================
    function addCategory(e) {
        e.preventDefault();

        const newCategory = {
            id: Date.now(),
            name: $('#categoryName').val().trim(),
            type: $('#categoryType').val(),
            color: $('#categoryColor').val()
        };

        if (!newCategory.name || !newCategory.type) {
            Swal.fire('ข้อมูลไม่ครบถ้วน', 'กรุณากรอกชื่อและเลือกประเภทหมวดหมู่', 'warning');
            return;
        }
        
        appData.categories.push(newCategory);

        const handleSuccess = () => {
            loadCategories();
            updateAllTransactionCards();
            $('#categoryForm')[0].reset();
            $('#categoryColor').val('#42a5f5');
        };

        if (isGoogleSheetsMode) {
            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            google.script.run
                .withSuccessHandler(function (response) {
                    Swal.fire('สำเร็จ!', 'เพิ่มหมวดหมู่เรียบร้อยแล้ว', 'success').then(() => {
                        categoryModalInstance.hide();
                    });
                    handleSuccess();
                })
                .withFailureHandler(function (error) {
                    Swal.fire('ข้อผิดพลาด', 'ไม่สามารถบันทึกหมวดหมู่ได้', 'error');
                })
                .saveCategory(newCategory);
        } else {
            saveData();
            Swal.fire('สำเร็จ!', 'เพิ่มหมวดหมู่เรียบร้อยแล้ว', 'success').then(() => {
                categoryModalInstance.hide();
            });
            handleSuccess();
        }
    }

    function loadCategories() {
        const incomeList = $('#incomeList');
        const expenseList = $('#expenseList');
        const filterCategory = $('#filterCategory');

        incomeList.empty();
        expenseList.empty();
        filterCategory.empty();

        filterCategory.append(`<option value="">-- ทั้งหมด --</option>`);

        const incomeCategories = appData.categories.filter(c => c.type === 'income');
        const expenseCategories = appData.categories.filter(c => c.type === 'expense');

        function createCategoryCard(category) {
            const typeText = category.type === 'income' ? 'รายรับ' : 'รายจ่าย';
            const typeClass = category.type === 'income' ? 'success' : 'danger';

        return `
            <div class="card mb-2">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="me-3" style="width: 20px; height: 20px; background-color: ${category.color}; border-radius: 50%;"></div>
                        <div>
                            <strong>${category.name}</strong>
                            <br><small class="text-${typeClass}">${typeText}</small>
                        </div>
                    </div>
                    <button class="btn btn-danger btn-sm" onclick="deleteCategory(${category.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }

        incomeCategories.forEach(category => {
            incomeList.append(createCategoryCard(category));
            filterCategory.append(`<option value="${category.name}">${category.name}</option>`);
        });

        expenseCategories.forEach(category => {
            expenseList.append(createCategoryCard(category));
            filterCategory.append(`<option value="${category.name}">${category.name}</option>`);
        });
    }

    function deleteCategory(categoryId) {
      Swal.fire({
          title: 'ยืนยันการลบ',
          text: 'คุณต้องการลบหมวดหมู่นี้ใช่หรือไม่?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'ลบ',
          cancelButtonText: 'ยกเลิก'
      }).then((result) => {
          if (!result.isConfirmed) return;

          Swal.fire({
            title: 'กำลังลบข้อมูล...',
            allowOutsideClick: false,
            showConfirmButton: false
          });

          Swal.showLoading();

          appData.categories = appData.categories.filter(cat => cat.id !== categoryId);

          if (isGoogleSheetsMode) {
              google.script.run
                  .withSuccessHandler(function (response) {
                      loadCategories();
                      updateAllTransactionCards();
                      Swal.fire({
                          icon: 'success',
                          title: 'สำเร็จ',
                          text: 'ลบหมวดหมู่เรียบร้อยแล้ว'
                      });
                  })
                  .withFailureHandler(function (error) {
                      console.error('❌ เกิดข้อผิดพลาดในการลบหมวดหมู่:', error);
                      Swal.fire({
                          icon: 'error',
                          title: 'ข้อผิดพลาด',
                          text: 'ไม่สามารถลบหมวดหมู่ได้ กรุณาลองอีกครั้ง'
                      });
                  })
                  .deleteCategory(categoryId);
          } else {
              saveData();
              loadCategories();
              updateAllTransactionCards();

              Swal.fire({
                  icon: 'success',
                  title: 'สำเร็จ',
                  text: 'ลบหมวดหมู่เรียบร้อยแล้ว'
              });
          }
      });
    }

    function updateAllTransactionCards() {
        $('.transaction-card .type-select').each(function() {
            updateCategoriesFromType(this);
        });
    }
    
    // ===================================================================================
    // TRANSACTION MANAGEMENT
    // ===================================================================================
    function addTransactionCard() {
        const cardId = Date.now();
        const accountOptions = appData.accounts.map(acc => `<option value="${acc.id}">${acc.name}</option>`).join('');

        const card = `
            <div class="transaction-card" data-card-id="${cardId}">
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label class="form-label">วันที่</label>
                            <input type="date" class="form-control" name="date[]" value="${new Date().toISOString().split('T')[0]}" required>
                        </div>
                        <div class="col-md-3 mb-3">
                             <label class="form-label">บัญชี</label>
                             <select class="form-select" name="accountId[]" required>
                                <option value="">เลือกบัญชี</option>
                                ${accountOptions}
                             </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">ประเภท</label>
                            <select class="form-select type-select" name="type[]" required onchange="updateCategoriesFromType(this)">
                                <option value="expense" selected>รายจ่าย</option>
                                <option value="income">รายรับ</option>
                            </select>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label class="form-label">หมวดหมู่</label>
                            <select class="form-select category-select" name="category[]" required></select>
                        </div>
                    </div>
                    <div class="row">
                         <div class="col-md-5 mb-3">
                             <label class="form-label">จำนวนเงิน</label>
                             <input type="number" class="form-control" name="amount[]" placeholder="0.00" step="0.01" min="0" required>
                         </div>
                        <div class="col-md-5 mb-3">
                            <label class="form-label">รายละเอียด</label>
                            <input type="text" class="form-control" name="description[]" placeholder="รายละเอียด (ไม่บังคับ)">
                        </div>
                        <div class="col-md-2 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-danger w-100" onclick="removeTransactionCard(${cardId})">
                                <i class="fas fa-trash me-1"></i>ลบ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;
        $('#transactionCards').append(card);
        updateCategoriesFromType($(`div[data-card-id="${cardId}"] .type-select`)[0]);
    }

    function removeTransactionCard(cardId) {
        $(`div[data-card-id="${cardId}"]`).remove();
    }

    function updateCategoriesFromType(selectElement) {
        const selectedType = $(selectElement).val();
        const categorySelect = $(selectElement).closest('.transaction-card').find('.category-select');
        
        categorySelect.empty();
        categorySelect.append('<option value="">เลือกหมวดหมู่</option>');
        
        if (selectedType) {
            const filteredCategories = appData.categories.filter(cat => cat.type === selectedType);
            filteredCategories.forEach(category => {
                categorySelect.append(`<option value="${category.name}">${category.name}</option>`);
            });
        }
    }

    function saveTransactions(e) {
        e.preventDefault();
        const formData = new FormData(e.target);
        const dates = formData.getAll('date[]');
        const categories = formData.getAll('category[]');
        const types = formData.getAll('type[]');
        const descriptions = formData.getAll('description[]');
        const amounts = formData.getAll('amount[]');
        const accountIds = formData.getAll('accountId[]');

        if (dates.length === 0) {
            Swal.fire('ข้อผิดพลาด', 'กรุณาเพิ่มรายการอย่างน้อย 1 รายการ', 'error');
            return;
        }

        Swal.fire({
            title: 'ยืนยันการบันทึก',
            text: `คุณต้องการบันทึกทั้งหมด ${dates.length} รายการใช่หรือไม่?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'บันทึก',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (!result.isConfirmed) return;
            Swal.fire({ title: 'กำลังบันทึก...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            const newTransactions = [];
            for (let i = 0; i < dates.length; i++) {
                newTransactions.push({
                    id: Date.now() + Math.random(),
                    date: dates[i],
                    category: categories[i],
                    type: types[i],
                    description: descriptions[i],
                    amount: parseFloat(amounts[i]),
                    accountId: accountIds[i]
                });
            }
            
            appData.transactions.push(...newTransactions);
            
            if (isGoogleSheetsMode) {
                google.script.run
                    .withSuccessHandler(response => {
                        $('#transactionCards').empty();
                        addTransactionCard();
                        updateDashboard();
                        loadTransactionHistory();
                        populateDashboardMonths();
                        Swal.fire('สำเร็จ!', 'บันทึกรายการเรียบร้อยแล้ว', 'success');
                        transactionModalInstance.hide();
                    })
                    .withFailureHandler(error => {
                        console.error('Error saving transactions:', error);
                        const idsToRemove = new Set(newTransactions.map(t => t.id));
                        appData.transactions = appData.transactions.filter(t => !idsToRemove.has(t.id));
                        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถบันทึกข้อมูลได้', 'error');
                    })
                    .saveMultipleTransactions(newTransactions);
            } else {
                saveData();
                $('#transactionCards').empty();
                addTransactionCard();
                updateDashboard();
                loadTransactionHistory();
                populateDashboardMonths();
                Swal.fire('สำเร็จ!', 'บันทึกรายการเรียบร้อยแล้ว (โหมดออฟไลน์)', 'success');
                transactionModalInstance.hide();
            }
        });
    }

    function deleteTransaction(transactionId) {
        Swal.fire({
            title: 'ยืนยันการลบ',
            text: 'คุณต้องการลบรายการนี้ใช่หรือไม่?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'ลบ',
            cancelButtonText: 'ยกเลิก'
        }).then((result) => {
            if (!result.isConfirmed) return;

            const transactionToDelete = appData.transactions.find(t => t.id === transactionId);
            const transactionIndex = appData.transactions.findIndex(t => t.id === transactionId);
            if (!transactionToDelete) return;

            appData.transactions.splice(transactionIndex, 1);
            
            loadTransactionHistory();

            if (isGoogleSheetsMode) {
                Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        updateDashboard();
                        Swal.fire('สำเร็จ!', 'ลบรายการเรียบร้อยแล้ว', 'success');
                    })
                    .withFailureHandler(function(error) {
                        console.error('❌ Error deleting transaction:', error);
                        appData.transactions.splice(transactionIndex, 0, transactionToDelete);
                        loadTransactionHistory();
                        Swal.fire('เกิดข้อผิดพลาด!', 'ไม่สามารถลบรายการได้', 'error');
                    })
                    .deleteTransaction(transactionId);
            } else {
                saveData();
                updateDashboard();
                Swal.fire('สำเร็จ!', 'ลบรายการเรียบร้อยแล้ว (โหมดออฟไลน์)', 'success');
            }
        });
    }

    // ===================================================================================
    // DASHBOARD, CHARTS, BUDGET, TAX, & UTILITY FUNCTIONS
    // ===================================================================================
        function updateDashboard() {
            loadAccounts();
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const currentTransactions = appData.transactions.filter(t => t.date.startsWith(selectedMonth));
            
            const totalIncome = currentTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = currentTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            $('#totalIncome').text('฿' + totalIncome.toLocaleString());
            $('#totalExpense').text('฿' + totalExpense.toLocaleString());
            $('#balance').text('฿' + balance.toLocaleString());
            
            updateCharts();
            updateBudgetProgress();
            updateYearSummaryChart();
        }
        function updateCharts() {
            updateBudgetChart();
            updateIncomeChart();
            updateExpenseChart();
        }
    function updateBudgetChart() {
        const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
        const currentBudgets = appData.budgets[selectedMonth] || [];
        const expenseCategories = appData.categories.filter(cat => cat.type === 'expense');
        
        const labels = [];
        const budgetData = [];
        const actualData = [];
        
        expenseCategories.forEach(category => {
            const budget = currentBudgets.find(b => b.categoryId === category.id);
            const budgetAmount = budget ? budget.amount : 0;
            
            const actualAmount = appData.transactions
                .filter(t => t.date.startsWith(selectedMonth) && t.category === category.name && t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            if (budgetAmount > 0 || actualAmount > 0) {
                labels.push(category.name);
                budgetData.push(budgetAmount);
                actualData.push(actualAmount);
            }
        });

        const isDarkMode = $('body').attr('data-theme') === 'dark';
        const chartTextColor = isDarkMode ? '#c9d1d9' : '#4a4a4a';
        const gridColor = isDarkMode ? 'rgba(201, 209, 217, 0.2)' : 'rgba(0, 0, 0, 0.1)';
        
        const ctx = document.getElementById('budgetChart').getContext('2d');
        
        if (charts.budget) {
            charts.budget.destroy();
        }
        
        charts.budget = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'งบประมาณ',
                        data: budgetData,
                        backgroundColor: 'rgba(66, 165, 245, 0.7)',
                        borderColor: 'rgba(66, 165, 245, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'ใช้จริง',
                        data: actualData,
                        backgroundColor: 'rgba(245, 66, 66, 0.7)',
                        borderColor: 'rgba(245, 66, 66, 1)',
                        borderWidth: 1
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: chartTextColor,
                            callback: function(value) {
                                return '฿' + value.toLocaleString();
                            }
                        },
                        grid: {
                            color: gridColor
                        }
                    },
                    x: {
                         ticks: {
                            color: chartTextColor
                        },
                        grid: {
                            color: gridColor
                        }
                    }
                },
                plugins: {
                    legend: {
                        labels: {
                            color: chartTextColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return context.dataset.label + ': ฿' + context.parsed.y.toLocaleString();
                            }
                        }
                    }
                }
            }
        });
    }

    function updateIncomeChart() {
        const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);

        const incomeTransactions = appData.transactions.filter(t => 
            t.date.startsWith(selectedMonth) && t.type === 'income'
        );

        const categoryTotals = {};
        const categoryColors = {};

        incomeTransactions.forEach(transaction => {
            if (!categoryTotals[transaction.category]) {
                categoryTotals[transaction.category] = 0;
                const category = appData.categories.find(cat => cat.name === transaction.category);
                categoryColors[transaction.category] = category ? category.color : '#66bb6a';
            }
            categoryTotals[transaction.category] += transaction.amount;
        });

        const labels = Object.keys(categoryTotals);
        const data = Object.values(categoryTotals);
        const colors = labels.map(label => categoryColors[label]);

        const isDarkMode = $('body').attr('data-theme') === 'dark';
        const chartTextColor = isDarkMode ? '#c9d1d9' : '#4a4a4a';

        const ctx = document.getElementById('incomeChart').getContext('2d');

        if (charts.income) {
            charts.income.destroy();
        }

        charts.income = new Chart(ctx, {
            type: 'pie',
            data: {
                labels: labels,
                datasets: [{
                    data: data,
                    backgroundColor: colors,
                    borderColor: colors.map(color => color + 'FF'),
                    borderWidth: 2
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        labels: {
                            color: chartTextColor
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = ((context.parsed / total) * 100).toFixed(1);
                                return `${context.label}: ฿${context.parsed.toLocaleString()} (${percentage}%)`;
                            }
                        }
                    }
                }
            }
        });
    }
        function updateExpenseChart() {
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const expenseTransactions = appData.transactions.filter(t => 
                t.date.startsWith(selectedMonth) && t.type === 'expense'
            );
            
            const categoryTotals = {};
            const categoryColors = {};
            
            expenseTransactions.forEach(transaction => {
                if (!categoryTotals[transaction.category]) {
                    categoryTotals[transaction.category] = 0;
                    const category = appData.categories.find(cat => cat.name === transaction.category);
                    categoryColors[transaction.category] = category ? category.color : '#42a5f5';
                }
                categoryTotals[transaction.category] += transaction.amount;
            });
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = labels.map(label => categoryColors[label]);
            
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (charts.expense) {
                charts.expense.destroy();
            }
            
            charts.expense = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color + 'FF'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ฿' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBudgetProgress() {
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const currentBudgets = appData.budgets[selectedMonth] || [];
            const progressContainer = $('#budgetProgress');
            progressContainer.empty();

            if (currentBudgets.length === 0) {
                progressContainer.html('<p class="text-muted text-center">ยังไม่มีการตั้งงบประมาณ</p>');
                return;
            }

            currentBudgets.forEach(budget => {
                const category = appData.categories.find(cat => cat.id === budget.categoryId);
                if (!category) return;

                const actualAmount = appData.transactions
                    .filter(t => t.date.startsWith(selectedMonth) && t.category === category.name && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const percentage = budget.amount > 0 ? (actualAmount / budget.amount) * 100 : 0;
                const amountClass = percentage > 100 ? 'text-danger' : 'text-muted';

                let progressClass = 'bg-success';
                if (percentage > 100) {
                    progressClass = 'bg-danger';
                } else if (percentage > 80) {
                    progressClass = 'bg-warning';
                }

                const progressBar = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">${category.name}</span>
                            <span class="${amountClass}">฿${actualAmount.toLocaleString()} / ฿${budget.amount.toLocaleString()}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%;">
                                ${percentage.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;

                progressContainer.append(progressBar);
            });
        }
        function updateYearSummaryChart() {
            const currentYear = new Date().getFullYear();
            const monthNames = [
                'ม.ค.', 'ก.พ.', 'มี.ค.', 'เม.ย.', 'พ.ค.', 'มิ.ย.',
                'ก.ค.', 'ส.ค.', 'ก.ย.', 'ต.ค.', 'พ.ย.', 'ธ.ค.'
            ];
            
            const incomeData = [];
            const expenseData = [];
            
            for (let month = 0; month < 12; month++) {
                const monthStr = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                
                const monthTransactions = appData.transactions.filter(t => t.date.startsWith(monthStr));
                
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }
            
            const ctx = document.getElementById('yearSummaryChart').getContext('2d');
            
            if (charts.yearSummary) {
                charts.yearSummary.destroy();
            }
            
            charts.yearSummary = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: 'รายรับ',
                            data: incomeData,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#4caf50',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'รายจ่าย',
                            data: expenseData,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#f44336',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '฿' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const fullMonthNames = [
                                        'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                                        'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
                                    ];
                                    return `${fullMonthNames[monthIndex]} ${currentYear + 543}`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ฿${value.toLocaleString()}`;
                                },
                                afterBody: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const income = incomeData[monthIndex];
                                    const expense = expenseData[monthIndex];
                                    const balance = income - expense;
                                    const balanceText = balance >= 0 ? 'เหลือ' : 'ขาด';
                                    return [``, `${balanceText}: ฿${Math.abs(balance).toLocaleString()}`];
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    family: 'Prompt'
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBorderWidth: 3
                        }
                    }
                }
            });
        }
    
    // ===================================================================================
    // TRANSACTION HISTORY (ปรับปรุงใหม่ทั้งหมด)
    // ===================================================================================
    function loadTransactionHistory() {
        const cardContainer = $('#transactionCardList');
        cardContainer.empty();

        // ** REFACTOR: เปลี่ยนการกรองข้อมูลมาใช้ historyMonthSelect **
        const selectedMonth = $('#historyMonthSelect').val();

        // กรองข้อมูลเฉพาะเดือนที่เลือก หรือถ้าไม่มีการเลือก ให้แสดงทั้งหมด
        const filteredTransactions = selectedMonth 
            ? appData.transactions.filter(t => t.date.startsWith(selectedMonth))
            : appData.transactions;

        // เรียงลำดับจากใหม่ไปเก่า
        const sortedTransactions = filteredTransactions.slice().sort((a, b) => new Date(b.date) - new Date(a.date));

        if (sortedTransactions.length === 0) {
            cardContainer.html('<p class="text-center text-muted mt-3">ไม่พบรายการในเดือนนี้</p>');
            return;
        }

        sortedTransactions.forEach(transaction => {
            let iconClass, iconName, title, subtitle, amountClass, amountPrefix, amountText;

            const transactionDate = new Date(transaction.date).toLocaleDateString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });

            if (transaction.type === 'transfer') {
                const fromAcc = appData.accounts.find(a => a.id == transaction.from)?.name || 'N/A';
                const toAcc = appData.accounts.find(a => a.id == transaction.to)?.name || 'N/A';
                
                iconClass = 'transfer';
                iconName = 'fa-exchange-alt';
                title = 'โอนเงิน';
                subtitle = `จาก: ${fromAcc} ไปยัง: ${toAcc}`;
                amountClass = 'text-primary';
                amountPrefix = '';
                amountText = `฿${transaction.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;

            } else { // Income & Expense
                iconClass = transaction.type;
                iconName = transaction.type === 'income' ? 'fa-arrow-up' : 'fa-arrow-down';
                title = transaction.category;
                subtitle = transaction.description || transactionDate;
                amountClass = transaction.type === 'income' ? 'text-success' : 'text-danger';
                amountPrefix = transaction.type === 'income' ? '+' : '-';
                amountText = `฿${transaction.amount.toLocaleString('en-US', {minimumFractionDigits: 2})}`;
            }

            const cardHtml = `
                <div class="transaction-card">
                    <div class="transaction-card-icon ${iconClass}">
                        <i class="fas ${iconName}"></i>
                    </div>
                    <div class="transaction-card-details">
                        <h6>${title}</h6>
                        <small>${subtitle}</small>
                    </div>
                    <div class="transaction-card-amount ${amountClass}">
                        ${amountPrefix}${amountText}
                    </div>
                    <div class="transaction-card-delete">
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTransaction(${transaction.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            cardContainer.append(cardHtml);
        });
    }

    
    // ===================================================================================
    // TAX MANAGEMENT
    // ===================================================================================
    function populateTaxYear() {
        const yearSelect = $('#taxYearSelect');
        if (yearSelect.children().length > 0) return;
        const currentYear = new Date().getFullYear();
        for (let year = currentYear + 1; year >= currentYear - 5; year--) {
            yearSelect.append(`<option value="${year}">${year + 543}</option>`);
        }
    }

    function loadTaxData() {
        const selectedYear = $('#taxYearSelect').val();
        const yearData = appData.taxData[selectedYear];
        if (yearData) {
            $('#taxTotalIncome').val(yearData.totalIncome);
            $('#taxDeductibleExpenses').val(yearData.deductibleExpenses);
            $('#taxPaid').val(yearData.taxPaid);
        } else {
            const totalIncomeThisYear = appData.transactions
                .filter(t => t.date.startsWith(selectedYear) && t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            $('#taxTotalIncome').val(totalIncomeThisYear);
            $('#taxDeductibleExpenses, #taxPaid').val(0);
        }
        calculateTax();
    }

    function saveTaxData(e) {
        e.preventDefault();
        const taxData = {
            year: $('#taxYearSelect').val(),
            totalIncome: parseFloat($('#taxTotalIncome').val()) || 0,
            deductibleExpenses: parseFloat($('#taxDeductibleExpenses').val()) || 0,
            taxPaid: parseFloat($('#taxPaid').val()) || 0,
        };
        appData.taxData[taxData.year] = taxData;
        if (isGoogleSheetsMode) {
             google.script.run
                .withSuccessHandler(res => Swal.fire('สำเร็จ!', 'บันทึกข้อมูลภาษีเรียบร้อยแล้ว', 'success'))
                .withFailureHandler(err => Swal.fire('ผิดพลาด', 'ไม่สามารถบันทึกได้', 'error'))
                .saveTaxData(taxData);
        } else {
            saveData();
            Swal.fire('สำเร็จ!', 'บันทึกข้อมูลภาษีเรียบร้อยแล้ว', 'success');
        }
    }
    
    function calculateTax() {
        const totalIncome = parseFloat($('#taxTotalIncome').val()) || 0;
        const deductions = parseFloat($('#taxDeductibleExpenses').val()) || 0;
        const netIncome = Math.max(0, totalIncome - deductions);
        $('#taxNetIncome').text('฿' + netIncome.toLocaleString());

        let tax = 0;
        if (netIncome > 5000000) tax += (netIncome - 5000000) * 0.35;
        if (netIncome > 2000000) tax += (Math.min(netIncome, 5000000) - 2000000) * 0.30;
        if (netIncome > 1000000) tax += (Math.min(netIncome, 2000000) - 1000000) * 0.25;
        if (netIncome > 750000) tax += (Math.min(netIncome, 1000000) - 750000) * 0.20;
        if (netIncome > 500000) tax += (Math.min(netIncome, 750000) - 500000) * 0.15;
        if (netIncome > 300000) tax += (Math.min(netIncome, 500000) - 300000) * 0.10;
        if (netIncome > 150000) tax += (Math.min(netIncome, 300000) - 150000) * 0.05;

        $('#taxCalculated').text('฿' + tax.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}));
    }
    $('#taxTotalIncome, #taxDeductibleExpenses').on('input', calculateTax);
    
    // ===================================================================================
    // SETTINGS & UTILITY
    // ===================================================================================
        function showLoading() {
            $('#loadingOverlay').show();
            $('.main-content').addClass('loading').removeClass('loaded');
        }
        function hideLoading() {
            $('#loadingOverlay').addClass('fade-out');
            $('.main-content').removeClass('loading').addClass('loaded');
            
            setTimeout(() => {
                $('#loadingOverlay').hide().removeClass('fade-out');
            }, 500);
        }
        function updateLoadingStatus(message) {
            $('#loadingStatus').text(message);
        }
        function clearAllData() {
            Swal.fire({
                title: 'ยืนยันการล้างข้อมูล',
                text: 'คุณต้องการล้างข้อมูลทั้งหมดใช่หรือไม่? การกระทำนี้ไม่สามารถย้อนกลับได้',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: 'ล้างข้อมูล',
                cancelButtonText: 'ยกเลิก',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (!result.isConfirmed) return;

                if (isGoogleSheetsMode) {
                    Swal.fire({
                      title: 'กำลังลบข้อมูล...',
                      allowOutsideClick: false,
                      showConfirmButton: false
                    });

                    Swal.showLoading();
                    google.script.run
                        .withSuccessHandler(function(response) {

                            Swal.fire({
                                icon: 'success',
                                title: 'สำเร็จ',
                                text: 'ล้างข้อมูลทั้งหมดเรียบร้อยแล้ว'
                            }).then(function() {
                                google.script.run.withSuccessHandler((url)=>{
                                  window.open(url,'_top')
                                }).getURL()
                            });
                        })
                        .withFailureHandler(function(error) {
                            console.error('❌ Error clearing data:', error);

                            Swal.fire({
                                icon: 'error',
                                title: 'ข้อผิดพลาด',
                                text: 'ไม่สามารถล้างข้อมูลได้ กรุณาลองอีกครั้ง'
                            });
                        })
                        .clearAllData();
                } else {
                    localStorage.removeItem('financeApp');
                    google.script.run.withSuccessHandler((url)=>{
                      window.open(url,'_top')
                    }).getURL()
                }
            });
        }

    function populateBudgetMonthYear() {
        const monthSelect = $('#budgetMonthSelect');
        const yearSelect = $('#budgetYearSelect');

        const now = new Date();
        const currentMonth = now.getMonth() + 1;
        const currentYear = now.getFullYear();

        if (monthSelect.children().length === 0) {
            const monthNames = [
                'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
                'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
            ];
            monthNames.forEach((monthName, index) => {
                const monthValue = (index + 1).toString().padStart(2, '0');
                const selected = (index + 1 === currentMonth) ? 'selected' : '';
                monthSelect.append(`<option value="${monthValue}" ${selected}>${monthName}</option>`);
            });
        }

        if (yearSelect.children().length === 0) {
            for (let year = currentYear - 2; year <= currentYear + 5; year++) {
                const displayYear = year + 543;
                const selected = (year === currentYear) ? 'selected' : '';
                yearSelect.append(`<option value="${year}" ${selected}>${displayYear}</option>`);
            }
        }
    }

        function loadBudgetForm() {
            populateBudgetMonthYear();

            const selectedMonth = $('#budgetMonthSelect').val();
            const selectedYear = $('#budgetYearSelect').val();
            const selectedMonthYear = `${selectedYear}-${selectedMonth.padStart(2, '0')}`;

            const budgetTableBody = $('#budgetTableBody');
            budgetTableBody.empty();

            const expenseCategories = appData.categories.filter(cat => cat.type === 'expense');
            const currentBudgets = appData.budgets[selectedMonthYear] || [];

            expenseCategories.forEach(category => {
                const budget = currentBudgets.find(b => b.categoryId === category.id);
                const budgetAmount = budget ? budget.amount : 0;

                const actualAmount = appData.transactions
                    .filter(t => t.date.startsWith(selectedMonthYear) && t.category === category.name && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const remaining = budgetAmount - actualAmount;
                const remainingClass = remaining >= 0 ? 'text-success' : 'text-danger';

    const row = `
        <tr>
            <td>
                <div class="d-flex align-items-center">
                    <div class="me-2" style="width: 15px; height: 15px; background-color: ${category.color}; border-radius: 50%;"></div>
                    ${category.name}
                </div>
            </td>
            <td>
                <input type="number" class="form-control" name="budget_${category.id}" value="${budgetAmount}" min="0" step="0.01">
            </td>
            <td class="text-end">฿${actualAmount.toLocaleString()}</td>
            <td class="text-end ${remainingClass}">฿${remaining.toLocaleString()}</td>
        </tr>
    `;
                budgetTableBody.append(row);
            });
        }
        function saveBudget(e) {
          e.preventDefault();

        const submitButton = $('#budgetForm button[type="submit"]');
        const originalButtonHtml = submitButton.html();
        submitButton.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i>กำลังบันทึก...');
        const resetButton = () => submitButton.prop('disabled', false).html(originalButtonHtml);

          const selectedMonth = $('#budgetMonthSelect').val();
          const selectedYear = $('#budgetYearSelect').val();
          const selectedMonthYear = `${selectedYear}-${selectedMonth.padStart(2, '0')}`;

          const formData = new FormData(e.target);
          const budgets = [];

          appData.categories
              .filter(cat => cat.type === 'expense')
              .forEach(category => {
                  const amount = parseFloat(formData.get(`budget_${category.id}`)) || 0;
                  budgets.push({
                      categoryId: category.id,
                      amount: amount
                  });
              });

          appData.budgets[selectedMonthYear] = budgets;

          const monthNames = [
              'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
              'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
          ];
          const monthName = monthNames[parseInt(selectedMonth) - 1];
          const yearBE = parseInt(selectedYear) + 543;

          if (isGoogleSheetsMode) {
              Swal.fire({
                title: 'กำลังบันทึกข้อมูล...',
                allowOutsideClick: false,
                showConfirmButton: false
              });

              Swal.showLoading();

              google.script.run
                  .withSuccessHandler(function(response) {

                      updateDashboard();
                      loadBudgetForm();

                      Swal.fire({
                          icon: 'success',
                          title: 'สำเร็จ',
                          text: `บันทึกงบประมาณ ${monthName} ${yearBE} เรียบร้อยแล้ว`
                      });
                  })
                  .withFailureHandler(function(error) {
                      console.error('❌ Error saving budget:', error);

                      Swal.fire({
                          icon: 'error',
                          title: 'ข้อผิดพลาด',
                          text: 'ไม่สามารถบันทึกงบประมาณได้ กรุณาลองอีกครั้ง'
                      });
                  })
                  .saveBudget(selectedMonthYear, budgets);
          } else {
              saveData();
              updateDashboard();
              loadBudgetForm();

              Swal.fire({
                  icon: 'success',
                  title: 'สำเร็จ',
                  text: `บันทึกงบประมาณ ${monthName} ${yearBE} เรียบร้อยแล้ว`
              });
          }
      }
    function updateCurrentMonth() {
        const currentDate = new Date();
        const monthNames = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];
        const monthText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
        $('#currentMonth').text(monthText);
        $('#budgetMonth').text(monthText);
        $('#currentYear').text(currentDate.getFullYear() + 543);
    }
    function populateDashboardMonths() {
        const monthSelect = $('#dashboardMonth');
        const currentDate = new Date();
        const currentMonth = currentDate.toISOString().slice(0, 7);
        
        const months = [...new Set(appData.transactions.map(t => t.date.slice(0, 7)))];
        months.sort().reverse();
        
        if (!months.includes(currentMonth)) {
            months.unshift(currentMonth);
        }
        
        const monthNames = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];
        
        monthSelect.empty();
        months.forEach(month => {
            const [year, monthNum] = month.split('-');
            const monthName = monthNames[parseInt(monthNum) - 1];
            const displayText = `${monthName} ${parseInt(year) + 543}`;
            const option = `<option value="${month}">${displayText}</option>`;
            monthSelect.append(option);
        });
        
        monthSelect.val(currentMonth);
    }

    function populateHistoryMonths() {
        const monthSelect = $('#historyMonthSelect');
        const currentDate = new Date();
        const currentMonth = currentDate.toISOString().slice(0, 7);

        // ดึงข้อมูลเดือนทั้งหมดที่มีการทำรายการ
        const months = [...new Set(appData.transactions.map(t => t.date.slice(0, 7)))];
        months.sort((a, b) => b.localeCompare(a)); // เรียงจากใหม่ไปเก่า

        // เพิ่มเดือนปัจจุบันเข้าไป ถ้ายังไม่มี
        if (!months.includes(currentMonth)) {
            months.unshift(currentMonth);
        }
        
        const monthNames = [
            'มกราคม', 'กุมภาพันธ์', 'มีนาคม', 'เมษายน', 'พฤษภาคม', 'มิถุนายน',
            'กรกฎาคม', 'สิงหาคม', 'กันยายน', 'ตุลาคม', 'พฤศจิกายน', 'ธันวาคม'
        ];
        
        monthSelect.empty();
        months.forEach(month => {
            const [year, monthNum] = month.split('-');
            const monthName = monthNames[parseInt(monthNum) - 1];
            const displayText = `${monthName} ${parseInt(year) + 543}`;
            const option = `<option value="${month}">${displayText}</option>`;
            monthSelect.append(option);
        });
        
        // ตั้งค่าให้เดือนปัจจุบันเป็นค่าเริ่มต้น
        monthSelect.val(currentMonth);
    }

    function showConnectionStatus(isConnected) {
        $('.connection-status-alert').remove();

        let statusHtml;
        
        if (isConnected) {
            statusHtml = `
                <div class="alert alert-success alert-dismissible fade show connection-status-alert" role="alert">
                    <i class="fas fa-cloud-check me-2"></i>
                    <strong>ออนไลน์:</strong> เชื่อมต่อกับ Google Sheets สำเร็จ
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
        } else {
            statusHtml = `
                <div class="alert alert-warning alert-dismissible fade show connection-status-alert" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>ออฟไลน์:</strong> กำลังทำงานในโหมดออฟไลน์ ข้อมูลจะถูกบันทึกในเบราว์เซอร์
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>`;
        }
        
        $('.main-content').prepend(statusHtml);
        
        setTimeout(() => {
            $('.connection-status-alert').fadeOut(500);
        }, 5000);
    }

</script>
