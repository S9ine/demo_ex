    <script>
    // ===================================================================================
    // GLOBAL VARIABLES & APP INITIALIZATION
    // ===================================================================================

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏•‡∏±‡∏Å‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î (State Management)
    let appData = {
        transactions: [],
        categories: [],
        budgets: {}
    };

    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö instance ‡∏Ç‡∏≠‡∏á Chart.js ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ó‡∏≥‡∏•‡∏≤‡∏¢ (destroy) ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ
    let charts = {};
    // ‡∏ï‡∏±‡∏ß‡πÅ‡∏õ‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Å‡πá‡∏ö instance ‡∏Ç‡∏≠‡∏á DataTable ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
    let historyDataTable;
    // Flag ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets
    let isGoogleSheetsMode = false;

    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå
    $(document).ready(function() {
        initializeApp();
    });

    /**
     * @name initializeApp
     * @description ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡πÅ‡∏≠‡∏õ‡∏û‡∏•‡∏¥‡πÄ‡∏Ñ‡∏ä‡∏±‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
     * 1. ‡πÅ‡∏™‡∏î‡∏á Loading Overlay
     * 2. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Handlers ‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
     * 3. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÅ‡∏•‡∏∞‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
     * 4. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Theme ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
     */
    function initializeApp() {
        showLoading();
        setupEventHandlers();
        setupThemeSwitcher(); // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Theme Switcher
        checkGoogleSheetsConnection();
    }

    // ===================================================================================
    // THEME SWITCHER LOGIC üé®
    // ===================================================================================
    
    /**
     * @name setupThemeSwitcher
     * @description ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏∏‡πà‡∏°‡∏™‡∏•‡∏±‡∏ö Theme
     * 1. ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Theme ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ‡πÉ‡∏ô localStorage
     * 2. ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Theme ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡∏´‡∏≤‡∏Å‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ ‡∏à‡∏∞‡πÉ‡∏ä‡πâ light)
     * 3. ‡πÄ‡∏û‡∏¥‡πà‡∏° Event Listener ‡πÉ‡∏´‡πâ‡∏Å‡∏±‡∏ö‡∏õ‡∏∏‡πà‡∏° #theme-switcher
     * 4. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å ‡∏à‡∏∞‡∏™‡∏•‡∏±‡∏ö theme ‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ñ‡πà‡∏≤‡πÉ‡∏´‡∏°‡πà‡∏•‡∏á localStorage
     */
    function setupThemeSwitcher() {
        const switcher = $('#theme-switcher');
        const body = $('body');
        const currentTheme = localStorage.getItem('appTheme') || 'light';

        // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ theme ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ï‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ß‡πâ
        body.attr('data-theme', currentTheme);
        updateThemeIcon(currentTheme);

        switcher.on('click', function() {
            const newTheme = body.attr('data-theme') === 'light' ? 'dark' : 'light';
            body.attr('data-theme', newTheme);
            localStorage.setItem('appTheme', newTheme);
            updateThemeIcon(newTheme);

            updateDashboard();
        });

        function updateThemeIcon(theme) {
            if (theme === 'dark') {
                switcher.find('i').removeClass('fa-moon').addClass('fa-sun');
            } else {
                switcher.find('i').removeClass('fa-sun').addClass('fa-moon');
            }
        }
    }


        // Check Google Sheets connection
        function checkGoogleSheetsConnection() {
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheets...');

            google.script.run.withSuccessHandler(function() {
              isGoogleSheetsMode = true;

              updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
              initializeSheets();

            }).withFailureHandler(function(error) {
              console.error('Error connecting to Google Sheets:', error);
              fallbackToLocalMode();

            }).testConnection();
        }

        function initializeSheets() {
          google.script.run.withSuccessHandler(function() {
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...');
            loadDataFromSource();

          }).withFailureHandler(function(error) {
            console.error('Error initializing sheets:', error);
            fallbackToLocalMode();

          }).initializeSheets();
        }
        
        function fallbackToLocalMode() {
            updateLoadingStatus('‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå...');
            isGoogleSheetsMode = false;
            
            setTimeout(function() {
                loadDataFromSource();
            }, 1000);
        }

        // Show connection status
        function showConnectionStatus(isConnected) {
            let statusHtml;
            
            if (isConnected) {
                // Check if we have real data or sample data
                const hasRealData = appData.transactions.length > 0 && !appData.transactions[0].description.includes('‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á') && !appData.transactions[0].description.includes('‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô');
                
                if (hasRealData) {
                    statusHtml = '<div class="alert alert-success alert-dismissible fade show" role="alert"><i class="fas fa-cloud-check me-2"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ' + appData.transactions.length + ' ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                } else {
                    statusHtml = '<div class="alert alert-info alert-dismissible fade show" role="alert"><i class="fas fa-info-circle me-2"></i>‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠ Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
                }
            } else {
                statusHtml = '<div class="alert alert-warning alert-dismissible fade show" role="alert"><i class="fas fa-exclamation-triangle me-2"></i>‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÉ‡∏ô‡πÄ‡∏ö‡∏£‡∏≤‡∏ß‡πå‡πÄ‡∏ã‡∏≠‡∏£‡πå<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
            }
            
            $('.main-content').prepend(statusHtml);
            
            // Auto hide after 3 seconds for info messages
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 3000);
        }
        
        // ‚úÖ ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets (‡∏´‡∏£‡∏∑‡∏≠ local fallback)
        function loadDataFromSource() {
            if (isGoogleSheetsMode) {
                google.script.run
                    .withSuccessHandler(function(data) {

                        if (data && typeof data === 'object') {
                            // üßæ Transactions
                            if (Array.isArray(data.transactions)) {
                                appData.transactions = data.transactions.map(t => {
                                    let dateStr = t.date;
                                    if (t.date && typeof t.date === 'object') {
                                        dateStr = new Date(t.date).toISOString().split('T')[0];
                                    } else if (typeof t.date === 'string' && t.date.includes('GMT')) {
                                        dateStr = new Date(t.date).toISOString().split('T')[0];
                                    } else if (typeof t.date === 'string' && /^\d{4}-\d{2}-\d{2}$/.test(t.date)) {
                                        dateStr = t.date;
                                    } else {
                                        const date = new Date(t.date);
                                        dateStr = !isNaN(date.getTime()) ? date.toISOString().split('T')[0] : new Date().toISOString().split('T')[0];
                                    }
                                    return {
                                        id: t.id || (Date.now() + Math.random()),
                                        date: dateStr,
                                        category: t.category || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏',
                                        type: t.type || 'expense',
                                        description: t.description || '',
                                        amount: parseFloat(t.amount) || 0
                                    };
                                });
                            }

                            // üìÇ Categories
                            if (Array.isArray(data.categories)) {
                                appData.categories = data.categories.map(c => ({
                                    id: c.id,
                                    name: c.name,
                                    type: c.type,
                                    color: c.color || '#42a5f5'
                                }));
                            }

                            // üí∞ Budgets
                            if (data.budgets && typeof data.budgets === 'object') {
                                appData.budgets = data.budgets;
                            }
                        }

                        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏∑‡πâ‡∏ô‡∏ê‡∏≤‡∏ô
                        if (!appData.categories || appData.categories.length === 0) {
                            createDefaultCategories();
                        }

                        if (!appData.transactions || appData.transactions.length === 0) {
                            updateLoadingStatus('‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à - ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•');
                        } else {
                            updateLoadingStatus('‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Google Sheets ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
                        }

                        initializeUI();
                    })
                    .withFailureHandler(function(error) {
                        console.error('Error loading data:', error);
                        fallbackToLocalMode();
                    })
                    .getAppData();
            } else {
                loadData(); // local fallback
                if (!appData.transactions || appData.transactions.length === 0) {
                    createMockData();
                    saveData();
                }
                initializeUI();
            }
        }
        
        function initializeUI() {
            updateLoadingStatus('‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠...');
            
            setTimeout(function() {
                // Initialize all UI components
                updateCurrentMonth();
                populateDashboardMonths();
                addTransactionCard();
                updateDashboard();
                loadCategories();
                loadBudgetForm();
                loadTransactionHistory();
                
                showConnectionStatus(isGoogleSheetsMode);
                hideLoading();
            }, 500);
        }

        // Save data to appropriate source
        function saveDataToSource() {
            if (!isGoogleSheetsMode) {
                saveData();
            }
        }

        // Load data from localStorage or create mock data
        function loadData() {
            const savedData = localStorage.getItem('financeApp');
            if (savedData) {
                appData = JSON.parse(savedData);
            } else {
                createMockData();
                saveData();
            }
        }

        // Create default categories only
        function createDefaultCategories() {
            appData.categories = [
                { id: 1, name: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", type: "income", color: "#4caf50" },
                { id: 2, name: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°", type: "income", color: "#8bc34a" },
                { id: 3, name: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", type: "expense", color: "#ff9800" },
                { id: 4, name: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", type: "expense", color: "#f44336" },
                { id: 5, name: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", type: "expense", color: "#e91e63" },
                { id: 6, name: "‡∏ö‡∏¥‡∏•/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", type: "expense", color: "#9c27b0" }
            ];
        }

        // Create sample transactions to show the system works
        function createSampleTransactions() {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            
            appData.transactions = [
                {
                    id: Date.now() + 1,
                    date: currentDate.toISOString().split('T')[0],
                    category: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
                    type: "income",
                    amount: 35000,
                    description: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                },
                {
                    id: Date.now() + 2,
                    date: new Date(currentDate.getTime() - 86400000).toISOString().split('T')[0], // Yesterday
                    category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
                    type: "expense",
                    amount: 150,
                    description: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô"
                },
                {
                    id: Date.now() + 3,
                    date: new Date(currentDate.getTime() - 172800000).toISOString().split('T')[0], // 2 days ago
                    category: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
                    type: "expense",
                    amount: 80,
                    description: "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ñ"
                }
            ];
            
            // Set sample budget for current month
            appData.budgets[currentMonth] = [
                { categoryId: 3, amount: 5000 }, // ‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                { categoryId: 4, amount: 3000 }, // ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                { categoryId: 5, amount: 2000 }, // ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á
                { categoryId: 6, amount: 4000 }  // ‡∏ö‡∏¥‡∏•/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
            ];
            
        }

        // Create initial mock data
        function createMockData() {
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            
            appData = {
                transactions: [
                    {
                        id: 1,
                        date: "2025-01-01",
                        category: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô",
                        type: "income",
                        amount: 35000,
                        description: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô"
                    },
                    {
                        id: 2,
                        date: "2025-01-02",
                        category: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£",
                        type: "expense",
                        amount: 150,
                        description: "‡∏Ç‡πâ‡∏≤‡∏ß‡∏Å‡∏•‡∏≤‡∏á‡∏ß‡∏±‡∏ô"
                    },
                    {
                        id: 3,
                        date: "2025-01-03",
                        category: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á",
                        type: "expense",
                        amount: 80,
                        description: "‡∏Ñ‡πà‡∏≤‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô‡∏£‡∏ñ"
                    },
                    {
                        id: 4,
                        date: "2025-01-04",
                        category: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á",
                        type: "expense",
                        amount: 1200,
                        description: "‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏ú‡πâ‡∏≤"
                    },
                    {
                        id: 5,
                        date: "2025-01-05",
                        category: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°",
                        type: "income",
                        amount: 2000,
                        description: "‡∏á‡∏≤‡∏ô‡∏û‡∏¥‡πÄ‡∏®‡∏©"
                    }
                ],
                categories: [
                    { id: 1, name: "‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô", type: "income", color: "#4caf50" },
                    { id: 2, name: "‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡πÄ‡∏™‡∏£‡∏¥‡∏°", type: "income", color: "#8bc34a" },
                    { id: 3, name: "‡∏≠‡∏≤‡∏´‡∏≤‡∏£", type: "expense", color: "#ff9800" },
                    { id: 4, name: "‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á", type: "expense", color: "#f44336" },
                    { id: 5, name: "‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á", type: "expense", color: "#e91e63" },
                    { id: 6, name: "‡∏ö‡∏¥‡∏•/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢", type: "expense", color: "#9c27b0" }
                ],
                budgets: {}
            };
            
            // Set budget for current month
            appData.budgets[currentMonth] = [
                { categoryId: 3, amount: 5000 }, // ‡∏≠‡∏≤‡∏´‡∏≤‡∏£
                { categoryId: 4, amount: 3000 }, // ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
                { categoryId: 5, amount: 2000 }, // ‡∏ä‡πâ‡∏≠‡∏õ‡∏õ‡∏¥‡πâ‡∏á
                { categoryId: 6, amount: 4000 }  // ‡∏ö‡∏¥‡∏•/‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡πà‡∏≤‡∏¢
            ];
        }

        // Save data to localStorage
        function saveData() {
            localStorage.setItem('financeApp', JSON.stringify(appData));
        }

        // Setup event handlers
        function setupEventHandlers() {
            $('#transactionForm').on('submit', saveTransactions);
            $('#categoryForm').on('submit', addCategory);
            $('#budgetForm').on('submit', saveBudget);
        }

        // Navigation functions
        function showSection(sectionName) {
            $('.section').removeClass('active');
            $('#' + sectionName).addClass('active');
            
            $('.nav-link').removeClass('active');
            $(`a[onclick="showSection('${sectionName}')"]`).addClass('active');
            
            if (sectionName === 'dashboard') {
                updateDashboard();
            } else if (sectionName === 'transactions') {
                loadTransactionHistory();
            } else if (sectionName === 'categories') {
                loadCategories();
            } else if (sectionName === 'budget') {
                loadBudgetForm();
            }
        }

        // Update current month display
        function updateCurrentMonth() {
            const currentDate = new Date();
            const monthNames = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            const monthText = `${monthNames[currentDate.getMonth()]} ${currentDate.getFullYear() + 543}`;
            $('#currentMonth').text(monthText);
            $('#budgetMonth').text(monthText);
            $('#currentYear').text(currentDate.getFullYear() + 543);
        }

        // Populate dashboard month selector
        function populateDashboardMonths() {
            const monthSelect = $('#dashboardMonth');
            const currentDate = new Date();
            const currentMonth = currentDate.toISOString().slice(0, 7);
            
            // Get all unique months from transactions
            const months = [...new Set(appData.transactions.map(t => t.date.slice(0, 7)))];
            months.sort().reverse();
            
            // Add current month if not in list
            if (!months.includes(currentMonth)) {
                months.unshift(currentMonth);
            }
            
            const monthNames = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            
            monthSelect.empty();
            months.forEach(month => {
                const [year, monthNum] = month.split('-');
                const monthName = monthNames[parseInt(monthNum) - 1];
                const displayText = `${monthName} ${parseInt(year) + 543}`;
                const option = `<option value="${month}">${displayText}</option>`;
                monthSelect.append(option);
            });
            
            monthSelect.val(currentMonth);
        }

        // Transaction management
        function addTransactionCard() {
            const cardId = Date.now();
            
            const card = `
                <div class="transaction-card" data-card-id="${cardId}">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 mb-3">
                                <label class="form-label">‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà</label>
                                <input type="date" class="form-control" name="date[]" value="${new Date().toISOString().split('T')[0]}" required>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                                <select class="form-select type-select" name="type[]" required onchange="updateCategoriesFromType(this)">
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</option>
                                    <option value="expense" selected>‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢</option>
                                    <option value="income">‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</label>
                                <select class="form-select category-select" name="category[]" required>
                                    <option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>
                                </select>
                            </div>
                            <div class="col-md-3 mb-3">
                                <label class="form-label">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</label>
                                <input type="number" class="form-control" name="amount[]" placeholder="0.00" step="0.01" min="0" required>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-10 mb-3">
                                <label class="form-label">‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î</label>
                                <input type="text" class="form-control" name="description[]" placeholder="‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏á‡∏Ñ‡∏±‡∏ö)">
                            </div>
                            <div class="col-md-2 mb-3 d-flex align-items-end">
                                <button type="button" class="btn btn-danger w-100" onclick="removeTransactionCard(${cardId})">
                                    <i class="fas fa-trash me-1"></i>‡∏•‡∏ö
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            $('#transactionCards').append(card);
            
            // Initialize categories for the new card
            updateCategoriesFromType($(`div[data-card-id="${cardId}"] .type-select`)[0]);
        }

        function removeTransactionCard(cardId) {
            $(`div[data-card-id="${cardId}"]`).remove();
        }

        function updateCategoriesFromType(selectElement) {
            const selectedType = $(selectElement).val();
            const categorySelect = $(selectElement).closest('.transaction-card').find('.category-select');
            
            categorySelect.empty();
            categorySelect.append('<option value="">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà</option>');
            
            if (selectedType) {
                const filteredCategories = appData.categories.filter(cat => cat.type === selectedType);
                filteredCategories.forEach(category => {
                    categorySelect.append(`<option value="${category.name}">${category.name}</option>`);
                });
            }
        }

        function saveTransactions(e) {
          e.preventDefault();

          const formData = new FormData(e.target);
          const dates = formData.getAll('date[]');
          const categories = formData.getAll('category[]');
          const types = formData.getAll('type[]');
          const descriptions = formData.getAll('description[]');
          const amounts = formData.getAll('amount[]');

          if (dates.length === 0) {
              Swal.fire({
                  icon: 'error',
                  title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                  text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£'
              });
              return;
          }

        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            text: `‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ${dates.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?`,
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (!result.isConfirmed) return;

            Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                didOpen: () => {
                    Swal.showLoading();
                }
            });

            const newTransactions = [];
            for (let i = 0; i < dates.length; i++) {
                const transaction = {
                    // QA Improvement: ‡πÉ‡∏ä‡πâ Math.random() ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏•‡∏î‡πÇ‡∏≠‡∏Å‡∏≤‡∏™‡∏Å‡∏≤‡∏£‡∏ã‡πâ‡∏≥‡∏ã‡πâ‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á ID
                    // ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏≠‡∏õ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡∏ç‡πà‡∏Ç‡∏∂‡πâ‡∏ô ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ library ‡∏™‡∏£‡πâ‡∏≤‡∏á UUID/GUID ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏Å‡∏ß‡πà‡∏≤
                    id: Date.now() + Math.random(),
                    date: dates[i],
                    category: categories[i],
                    type: types[i],
                    description: descriptions[i],
                    amount: parseFloat(amounts[i])
                };
                newTransactions.push(transaction);
            }
              appData.transactions.push(...newTransactions);
            if (isGoogleSheetsMode) {
                google.script.run
                    .withSuccessHandler(function(response) {
                        // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI ‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
                        $('#transactionCards').empty();
                        addTransactionCard();
                        updateDashboard();
                        loadTransactionHistory();
                        populateDashboardMonths();
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error saving transactions:', error);

                        // *** QA Refactor Point: Rollback on Failure ***
                        // ‡∏´‡∏≤‡∏Å‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å appData
                        const idsToRemove = new Set(newTransactions.map(t => t.id));
                        appData.transactions = appData.transactions.filter(t => !idsToRemove.has(t.id));

                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error');
                    })
                    .saveMultipleTransactions(newTransactions);
            } else {
                // Local mode
                saveData(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏•‡∏á localStorage
                $('#transactionCards').empty();
                addTransactionCard();
                updateDashboard();
                loadTransactionHistory();
                populateDashboardMonths();
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)', 'success');
            }
        });
    }


        function copyLastMonthData() {
            const currentDate = new Date();
            const lastMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1);
            const lastMonthStr = lastMonth.toISOString().slice(0, 7);
            
            const lastMonthTransactions = appData.transactions.filter(t => t.date.startsWith(lastMonthStr));
            
            if (lastMonthTransactions.length === 0) {
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', '‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß', 'info');
                return;
            }
            
            $('#transactionCards').empty();
            
            lastMonthTransactions.forEach(transaction => {
                addTransactionCard();
                const lastCard = $('#transactionCards .transaction-card:last');
                lastCard.find('input[name="date[]"]').val(new Date().toISOString().split('T')[0]);
                lastCard.find('select[name="type[]"]').val(transaction.type);
                
                // Update categories based on type first
                updateCategoriesFromType(lastCard.find('select[name="type[]"]')[0]);
                
                // Then set the category
                setTimeout(() => {
                    lastCard.find('select[name="category[]"]').val(transaction.category);
                }, 100);
                
                lastCard.find('input[name="description[]"]').val(transaction.description);
                lastCard.find('input[name="amount[]"]').val(transaction.amount);
            });
            
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ${lastMonthTransactions.length} ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≤‡∏Å‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        // Category management
        function addCategory(e) {
            e.preventDefault();

            const name = $('#categoryName').val().trim();
            const type = $('#categoryType').val();
            const color = $('#categoryColor').val();

            if (!name) {
                Swal.fire({
                    icon: 'warning',
                    title: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà',
                    text: '‡∏ä‡∏∑‡πà‡∏≠‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á'
                });
                return;
            }

            const newCategory = {
                id: Date.now(),
                name: name,
                type: type,
                color: color
            };

            // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏•‡∏á‡πÉ‡∏ô memory ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
            appData.categories.push(newCategory);

            if (isGoogleSheetsMode) {
                Swal.fire({
                  title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                  allowOutsideClick: false,
                  showConfirmButton: false
                });

                Swal.showLoading();

                google.script.run
                    .withSuccessHandler(function (response) {

                        // ‡πÇ‡∏´‡∏•‡∏î‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync UI
                        loadCategories();
                        updateAllTransactionCards();

                        // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
                        $('#categoryForm')[0].reset();
                        $('#categoryColor').val('#42a5f5');

                        Swal.fire({
                            icon: 'success',
                            title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                            text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                        });
                    })
                    .withFailureHandler(function (error) {
                        console.error('‚ùå Error saving category:', error);

                        Swal.fire({
                            icon: 'error',
                            title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                            text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                        });
                    })
                    .saveCategory(newCategory); // ‚Üê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Apps Script
            } else {
                // Local mode
                saveData();
                loadCategories();
                updateAllTransactionCards();

                // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ü‡∏≠‡∏£‡πå‡∏°
                $('#categoryForm')[0].reset();
                $('#categoryColor').val('#42a5f5');

                Swal.fire({
                    icon: 'success',
                    title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                    text: '‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                });
            }
        }


        function loadCategories() {
            const incomeList = $('#incomeList');
            const expenseList = $('#expenseList');
            const filterCategory = $('#filterCategory');

            incomeList.empty();
            expenseList.empty();
            filterCategory.empty();

            // ‡πÄ‡∏û‡∏¥‡πà‡∏° option ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
            filterCategory.append(`<option value="">-- ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î --</option>`);

            const incomeCategories = appData.categories.filter(c => c.type === 'income');
            const expenseCategories = appData.categories.filter(c => c.type === 'expense');

            function createCategoryCard(category) {
                const typeText = category.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢';
                const typeClass = category.type === 'income' ? 'success' : 'danger';

    return `
        <div class="card mb-2">
            <div class="card-body d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <div class="me-3" style="width: 20px; height: 20px; background-color: ${category.color}; border-radius: 50%;"></div>
                    <div>
                        <strong>${category.name}</strong>
                        <br><small class="text-${typeClass}">${typeText}</small>
                    </div>
                </div>
                <button class="btn btn-danger btn-sm" onclick="deleteCategory(${category.id})">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
    `;
}

            incomeCategories.forEach(category => {
                incomeList.append(createCategoryCard(category));
                filterCategory.append(`<option value="${category.name}">${category.name}</option>`);
            });

            expenseCategories.forEach(category => {
                expenseList.append(createCategoryCard(category));
                filterCategory.append(`<option value="${category.name}">${category.name}</option>`);
            });
        }



        function updateAllTransactionCards() {
            $('.transaction-card .type-select').each(function() {
                updateCategoriesFromType(this);
            });
        }

        function deleteCategory(categoryId) {
          Swal.fire({
              title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
              text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
              icon: 'warning',
              showCancelButton: true,
              confirmButtonText: '‡∏•‡∏ö',
              cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
          }).then((result) => {
              if (!result.isConfirmed) return;

              Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                showConfirmButton: false
              });

              Swal.showLoading();

              // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å memory ‡∏Å‡πà‡∏≠‡∏ô
              appData.categories = appData.categories.filter(cat => cat.id !== categoryId);

              if (isGoogleSheetsMode) {
                  google.script.run
                      .withSuccessHandler(function (response) {

                          // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡∏°‡πà‡∏à‡∏≤‡∏Å Google Sheets ‡πÄ‡∏û‡∏∑‡πà‡∏≠ sync UI
                          loadCategories();
                          updateAllTransactionCards();

                          Swal.fire({
                              icon: 'success',
                              title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                              text: '‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                          });
                      })
                      .withFailureHandler(function (error) {
                          console.error('‚ùå ‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà:', error);
                          Swal.fire({
                              icon: 'error',
                              title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                              text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                          });
                      })
                      .deleteCategory(categoryId); // ‚Üê ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô Apps Script
              } else {
                  // Local mode
                  saveData();
                  loadCategories();
                  updateAllTransactionCards();

                  Swal.fire({
                      icon: 'success',
                      title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                      text: '‡∏•‡∏ö‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                  });
              }
          });
      }


        // Budget management
        function loadBudgetForm() {
            populateBudgetMonthYear();

            const selectedMonth = $('#budgetMonthSelect').val();
            const selectedYear = $('#budgetYearSelect').val();
            const selectedMonthYear = `${selectedYear}-${selectedMonth.padStart(2, '0')}`; // YYYY-MM

            const budgetTableBody = $('#budgetTableBody');
            budgetTableBody.empty();

            // Filter ‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà expense
            const expenseCategories = appData.categories.filter(cat => cat.type === 'expense');

            // ‡∏î‡∏∂‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏Ç‡∏≠‡∏á‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ
            const currentBudgets = appData.budgets[selectedMonthYear] || [];

            expenseCategories.forEach(category => {
                const budget = currentBudgets.find(b => b.categoryId === category.id);
                const budgetAmount = budget ? budget.amount : 0;

                // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡πà‡∏≤‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á
                const actualAmount = appData.transactions
                    .filter(t => t.date.startsWith(selectedMonthYear) && t.category === category.name && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const remaining = budgetAmount - actualAmount;
                const remainingClass = remaining >= 0 ? 'text-success' : 'text-danger';

                const row = `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2" style="width: 15px; height: 15px; background-color: ${category.color}; border-radius: 50%;"></div>
                                ${category.name}
                            </div>
                        </td>
                        <td>
                            <input type="number" class="form-control" name="budget_${category.id}" value="${budgetAmount}" min="0" step="0.01">
                        </td>
                        <td class="text-end">‡∏ø${actualAmount.toLocaleString()}</td>
                        <td class="text-end ${remainingClass}">‡∏ø${remaining.toLocaleString()}</td>
                    </tr>
                `;
                budgetTableBody.append(row);
            });
        }


        function populateBudgetMonthYear() {
            const monthSelect = $('#budgetMonthSelect');
            const yearSelect = $('#budgetYearSelect');

            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1‚Äì12
            const currentYear = now.getFullYear();

            // Populate months if empty
            if (monthSelect.children().length === 0) {
                const monthNames = [
                    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                ];

                monthNames.forEach((monthName, index) => {
                    const monthValue = (index + 1).toString().padStart(2, '0'); // 01‚Äì12
                    const selected = (index + 1 === currentMonth) ? 'selected' : '';
                    monthSelect.append(`<option value="${monthValue}" ${selected}>${monthName}</option>`);
                });
            }

            // Populate years if empty
            if (yearSelect.children().length === 0) {
                for (let year = currentYear - 2; year <= currentYear + 5; year++) {
                    const displayYear = year + 543; // Convert to Buddhist year
                    const selected = (year === currentYear) ? 'selected' : '';
                    yearSelect.append(`<option value="${year}" ${selected}>${displayYear}</option>`);
                }
            }

            // Safety check: ‡∏ñ‡πâ‡∏≤ select ‡∏°‡∏µ ‡πÅ‡∏ï‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ñ‡πà‡∏≤ ‡πÉ‡∏´‡πâ‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
            if (!monthSelect.val()) monthSelect.val(currentMonth.toString().padStart(2, '0'));
            if (!yearSelect.val()) yearSelect.val(currentYear.toString());
        }



        function saveBudget(e) {
          e.preventDefault();

          const selectedMonth = $('#budgetMonthSelect').val();
          const selectedYear = $('#budgetYearSelect').val();
          const selectedMonthYear = `${selectedYear}-${selectedMonth.padStart(2, '0')}`;

          const formData = new FormData(e.target);
          const budgets = [];

          // ‡πÄ‡∏Å‡πá‡∏ö‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å‡∏ü‡∏≠‡∏£‡πå‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏ï‡πà‡∏•‡∏∞‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà expense
          appData.categories
              .filter(cat => cat.type === 'expense')
              .forEach(category => {
                  const amount = parseFloat(formData.get(`budget_${category.id}`)) || 0;
                  budgets.push({
                      categoryId: category.id,
                      amount: amount
                  });
              });

          // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï memory
          appData.budgets[selectedMonthYear] = budgets;

          const monthNames = [
              '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
              '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
          ];
          const monthName = monthNames[parseInt(selectedMonth) - 1];
          const yearBE = parseInt(selectedYear) + 543;

          if (isGoogleSheetsMode) {
              Swal.fire({
                title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                allowOutsideClick: false,
                showConfirmButton: false
              });

              Swal.showLoading();

              google.script.run
                  .withSuccessHandler(function(response) {

                      updateDashboard();
                      loadBudgetForm();

                      Swal.fire({
                          icon: 'success',
                          title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                          text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${monthName} ${yearBE} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
                      });
                  })
                  .withFailureHandler(function(error) {
                      console.error('‚ùå Error saving budget:', error);

                      Swal.fire({
                          icon: 'error',
                          title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                          text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                      });
                  })
                  .saveBudget(selectedMonthYear, budgets); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script
          } else {
              // Local mode
              saveData();
              updateDashboard();
              loadBudgetForm();

              Swal.fire({
                  icon: 'success',
                  title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                  text: `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${monthName} ${yearBE} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`
              });
          }
      }


        function copyLastMonthBudget() {
            const selectedMonth = parseInt($('#budgetMonthSelect').val());
            const selectedYear = parseInt($('#budgetYearSelect').val());
            
            // Calculate previous month
            let prevMonth = selectedMonth - 1;
            let prevYear = selectedYear;
            
            if (prevMonth === 0) {
                prevMonth = 12;
                prevYear = selectedYear - 1;
            }
            
            const prevMonthStr = `${prevYear}-${prevMonth.toString().padStart(2, '0')}`;
            const lastMonthBudgets = appData.budgets[prevMonthStr];
            
            if (!lastMonthBudgets || lastMonthBudgets.length === 0) {
                const monthNames = [
                    '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                    '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                ];
                const prevMonthName = monthNames[prevMonth - 1];
                const prevYearBE = prevYear + 543;
                
                Swal.fire('‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', `‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡πÉ‡∏ô ${prevMonthName} ${prevYearBE}`, 'info');
                return;
            }
            
            lastMonthBudgets.forEach(budget => {
                $(`input[name="budget_${budget.categoryId}"]`).val(budget.amount);
            });
            
            const monthNames = [
                '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
            ];
            const prevMonthName = monthNames[prevMonth - 1];
            const prevYearBE = prevYear + 543;
            
            Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à', `‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì‡∏à‡∏≤‡∏Å ${prevMonthName} ${prevYearBE} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        }

        // Dashboard functions
        function updateDashboard() {
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const currentTransactions = appData.transactions.filter(t => t.date.startsWith(selectedMonth));
            
            const totalIncome = currentTransactions
                .filter(t => t.type === 'income')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const totalExpense = currentTransactions
                .filter(t => t.type === 'expense')
                .reduce((sum, t) => sum + t.amount, 0);
            
            const balance = totalIncome - totalExpense;
            
            $('#totalIncome').text('‡∏ø' + totalIncome.toLocaleString());
            $('#totalExpense').text('‡∏ø' + totalExpense.toLocaleString());
            $('#balance').text('‡∏ø' + balance.toLocaleString());
            
            updateCharts();
            updateBudgetProgress();
            updateYearSummaryChart();
        }

        function updateCharts() {
            updateBudgetChart();
            updateIncomeChart();
            updateExpenseChart();
        }

function updateBudgetChart() {
    const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
    const currentBudgets = appData.budgets[selectedMonth] || [];
    const expenseCategories = appData.categories.filter(cat => cat.type === 'expense');
    
    const labels = [];
    const budgetData = [];
    const actualData = [];
    
    expenseCategories.forEach(category => {
        const budget = currentBudgets.find(b => b.categoryId === category.id);
        const budgetAmount = budget ? budget.amount : 0;
        
        const actualAmount = appData.transactions
            .filter(t => t.date.startsWith(selectedMonth) && t.category === category.name && t.type === 'expense')
            .reduce((sum, t) => sum + t.amount, 0);
        
        if (budgetAmount > 0 || actualAmount > 0) {
            labels.push(category.name);
            budgetData.push(budgetAmount);
            actualData.push(actualAmount);
        }
    });

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode ---
    const isDarkMode = $('body').attr('data-theme') === 'dark';
    const chartTextColor = isDarkMode ? '#c9d1d9' : '#4a4a4a';
    const gridColor = isDarkMode ? 'rgba(201, 209, 217, 0.2)' : 'rgba(0, 0, 0, 0.1)';
    // ------------------------------------
    
    const ctx = document.getElementById('budgetChart').getContext('2d');
    
    if (charts.budget) {
        charts.budget.destroy();
    }
    
    charts.budget = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: '‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì',
                    data: budgetData,
                    backgroundColor: 'rgba(66, 165, 245, 0.7)',
                    borderColor: 'rgba(66, 165, 245, 1)',
                    borderWidth: 1
                },
                {
                    label: '‡πÉ‡∏ä‡πâ‡∏à‡∏£‡∏¥‡∏á',
                    data: actualData,
                    backgroundColor: 'rgba(245, 66, 66, 0.7)',
                    borderColor: 'rgba(245, 66, 66, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode ---
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: chartTextColor, // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏Å‡∏ô Y
                        callback: function(value) {
                            return '‡∏ø' + value.toLocaleString();
                        }
                    },
                    grid: {
                        color: gridColor // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô Grid ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡∏ô Y
                    }
                },
                x: {
                     ticks: {
                        color: chartTextColor // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡πÅ‡∏Å‡∏ô X
                    },
                    grid: {
                        color: gridColor // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡πÄ‡∏™‡πâ‡∏ô Grid ‡∏Ç‡∏≠‡∏á‡πÅ‡∏Å‡∏ô X
                    }
                }
            },
            plugins: {
                legend: {
                    labels: {
                        color: chartTextColor // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Legend
                    }
                },
            // ------------------------------------
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ‡∏ø' + context.parsed.y.toLocaleString();
                        }
                    }
                }
            }
        }
    });
}


function updateIncomeChart() {
    const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);

    const incomeTransactions = appData.transactions.filter(t => 
        t.date.startsWith(selectedMonth) && t.type === 'income'
    );

    const categoryTotals = {};
    const categoryColors = {};

    incomeTransactions.forEach(transaction => {
        if (!categoryTotals[transaction.category]) {
            categoryTotals[transaction.category] = 0;
            const category = appData.categories.find(cat => cat.name === transaction.category);
            categoryColors[transaction.category] = category ? category.color : '#66bb6a'; // default ‡∏™‡∏µ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        }
        categoryTotals[transaction.category] += transaction.amount;
    });

    const labels = Object.keys(categoryTotals);
    const data = Object.values(categoryTotals);
    const colors = labels.map(label => categoryColors[label]);

    // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode ---
    const isDarkMode = $('body').attr('data-theme') === 'dark';
    const chartTextColor = isDarkMode ? '#c9d1d9' : '#4a4a4a';
    // ------------------------------------

    const ctx = document.getElementById('incomeChart').getContext('2d');

    if (charts.income) {
        charts.income.destroy();
    }

    charts.income = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                data: data,
                backgroundColor: colors,
                borderColor: colors.map(color => color + 'FF'),
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                // --- ‡∏™‡πà‡∏ß‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°/‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dark Mode ---
                legend: {
                    labels: {
                        color: chartTextColor // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£‡∏Ç‡∏≠‡∏á Legend
                    }
                },
                // ------------------------------------
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const total = context.dataset.data.reduce((a, b) => a + b, 0);
                            const percentage = ((context.parsed / total) * 100).toFixed(1);
                            return `${context.label}: ‡∏ø${context.parsed.toLocaleString()} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}


        function updateExpenseChart() {
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const expenseTransactions = appData.transactions.filter(t => 
                t.date.startsWith(selectedMonth) && t.type === 'expense'
            );
            
            const categoryTotals = {};
            const categoryColors = {};
            
            expenseTransactions.forEach(transaction => {
                if (!categoryTotals[transaction.category]) {
                    categoryTotals[transaction.category] = 0;
                    const category = appData.categories.find(cat => cat.name === transaction.category);
                    categoryColors[transaction.category] = category ? category.color : '#42a5f5';
                }
                categoryTotals[transaction.category] += transaction.amount;
            });
            
            const labels = Object.keys(categoryTotals);
            const data = Object.values(categoryTotals);
            const colors = labels.map(label => categoryColors[label]);
            
            const ctx = document.getElementById('expenseChart').getContext('2d');
            
            if (charts.expense) {
                charts.expense.destroy();
            }
            
            charts.expense = new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: colors.map(color => color + 'FF'),
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return context.label + ': ‡∏ø' + context.parsed.toLocaleString() + ' (' + percentage + '%)';
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateBudgetProgress() {
            const selectedMonth = $('#dashboardMonth').val() || new Date().toISOString().slice(0, 7);
            const currentBudgets = appData.budgets[selectedMonth] || [];
            const progressContainer = $('#budgetProgress');
            progressContainer.empty();

            if (currentBudgets.length === 0) {
                progressContainer.html('<p class="text-muted text-center">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏á‡∏ö‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</p>');
                return;
            }

            currentBudgets.forEach(budget => {
                const category = appData.categories.find(cat => cat.id === budget.categoryId);
                if (!category) return;

                const actualAmount = appData.transactions
                    .filter(t => t.date.startsWith(selectedMonth) && t.category === category.name && t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);

                const percentage = budget.amount > 0 ? (actualAmount / budget.amount) * 100 : 0;

                // ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏™‡∏µ‡πÅ‡∏î‡∏á‡∏ñ‡πâ‡∏≤‡πÄ‡∏Å‡∏¥‡∏ô‡∏á‡∏ö
                const amountClass = percentage > 100 ? 'text-danger' : 'text-muted';

                // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏™‡∏µ‡∏Ç‡∏≠‡∏á progress bar ‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç
                let progressClass = 'bg-success';
                if (percentage > 100) {
                    progressClass = 'bg-danger';
                } else if (percentage > 80) {
                    progressClass = 'bg-warning';
                }

                const progressBar = `
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="fw-bold">${category.name}</span>
                            <span class="${amountClass}">‡∏ø${actualAmount.toLocaleString()} / ‡∏ø${budget.amount.toLocaleString()}</span>
                        </div>
                        <div class="progress">
                            <div class="progress-bar ${progressClass}" style="width: ${Math.min(percentage, 100)}%;">
                                ${percentage.toFixed(1)}%
                            </div>
                        </div>
                    </div>
                `;

                progressContainer.append(progressBar);
            });
        }






        // ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• + ‡∏Å‡∏£‡∏≠‡∏á
        function loadTransactionHistory() {
            if (historyDataTable) {
                historyDataTable.destroy();
            }

            const tableBody = $('#historyTable tbody');
            tableBody.empty();

            const selectedCategory = $('#filterCategory').val();
            const startDate = $('#filterStartDate').val() ? new Date($('#filterStartDate').val()) : null;
            const endDate = $('#filterEndDate').val() ? new Date($('#filterEndDate').val()) : null;

            const filteredTransactions = appData.transactions.filter(transaction => {
                let match = true;

                if (selectedCategory && transaction.category !== selectedCategory) {
                    match = false;
                }

                const transDate = new Date(transaction.date);
                if (startDate && transDate < startDate) {
                    match = false;
                }
                if (endDate) {
                    endDate.setHours(23, 59, 59, 999);
                    if (transDate > endDate) {
                        match = false;
                    }
                }

                return match;
            }).slice().reverse();

            filteredTransactions.forEach(transaction => {
                const typeText = transaction.type === 'income' ? '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö' : '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢';
                const typeClass = transaction.type === 'income' ? 'success' : 'danger';
                const amountText = transaction.type === 'income' ? '+' : '-';

                const row = `
                    <tr>
                        <td>${new Date(transaction.date).toLocaleDateString('th-TH')}</td>
                        <td>${transaction.category}</td>
                        <td><span class="badge bg-${typeClass}">${typeText}</span></td>
                        <td>${transaction.description}</td>
                        <td class="text-end text-${typeClass}">${amountText}‡∏ø${transaction.amount.toLocaleString()}</td>
                        <td class="text-center">
                            <button class="btn btn-danger btn-sm" onclick="deleteTransaction(${transaction.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tableBody.append(row);
            });

            historyDataTable = $('#historyTable').DataTable({
                language: {
                    url: 'https://cdn.datatables.net/plug-ins/1.13.6/i18n/th.json'
                },
                order: [[0, 'desc']],
                pageLength: 10,
                responsive: true
            });
        }

        $('#filterCategory, #filterStartDate, #filterEndDate').on('change', function () {
            loadTransactionHistory();
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á
        $('#resetFilter').on('click', function () {
            $('#filterCategory').val('');
            $('#filterStartDate').val('');
            $('#filterEndDate').val('');
            loadTransactionHistory();
        });

    /**
     * @name deleteTransaction
     * @description ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ò‡∏∏‡∏£‡∏Å‡∏£‡∏£‡∏°
     * @param {number} transactionId - ID ‡∏Ç‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö
     * QA Refactor:
     * - ‡πÄ‡∏Å‡πá‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö‡πÑ‡∏ß‡πâ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß
     * - ‡∏´‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏ó‡∏µ‡πà Backend ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß ‡∏à‡∏∞‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏π‡πà appData (Rollback)
     */
    function deleteTransaction(transactionId) {
        Swal.fire({
            title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö',
            text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: '‡∏•‡∏ö',
            cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å'
        }).then((result) => {
            if (!result.isConfirmed) return;

            // *** QA Refactor Point: Backup for Rollback ***
            const transactionToDelete = appData.transactions.find(t => t.id === transactionId);
            const transactionIndex = appData.transactions.findIndex(t => t.id === transactionId);
            if (!transactionToDelete) return; // ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏•‡∏ö

            // ‡∏•‡∏ö‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å Memory ‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (Optimistic UI)
            appData.transactions.splice(transactionIndex, 1);
            
            // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏´‡πá‡∏ô‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå
            loadTransactionHistory();

            if (isGoogleSheetsMode) {
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                google.script.run
                    .withSuccessHandler(function(response) {
                        updateDashboard(); // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï Dashboard ‡∏´‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                    })
                    .withFailureHandler(function(error) {
                        console.error('‚ùå Error deleting transaction:', error);

                        // *** QA Refactor Point: Rollback on Failure ***
                        // ‡∏´‡∏≤‡∏Å‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à, ‡∏ô‡∏≥‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏™‡∏≥‡∏£‡∏≠‡∏á‡πÑ‡∏ß‡πâ‡∏Å‡∏•‡∏±‡∏ö‡∏Ñ‡∏∑‡∏ô‡∏™‡∏π‡πà‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡πÄ‡∏î‡∏¥‡∏°
                        appData.transactions.splice(transactionIndex, 0, transactionToDelete);
                        loadTransactionHistory(); // ‡πÇ‡∏´‡∏•‡∏î‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤

                        Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÑ‡∏î‡πâ', 'error');
                    })
                    .deleteTransaction(transactionId);
            } else {
                saveData();
                updateDashboard();
                Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏•‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß (‡πÇ‡∏´‡∏°‡∏î‡∏≠‡∏≠‡∏ü‡πÑ‡∏•‡∏ô‡πå)', 'success');
            }
        });
    }


        // Year Summary Chart
        function updateYearSummaryChart() {
            const currentYear = new Date().getFullYear();
            const monthNames = [
                '‡∏°.‡∏Ñ.', '‡∏Å.‡∏û.', '‡∏°‡∏µ.‡∏Ñ.', '‡πÄ‡∏°.‡∏¢.', '‡∏û.‡∏Ñ.', '‡∏°‡∏¥.‡∏¢.',
                '‡∏Å.‡∏Ñ.', '‡∏™.‡∏Ñ.', '‡∏Å.‡∏¢.', '‡∏ï.‡∏Ñ.', '‡∏û.‡∏¢.', '‡∏ò.‡∏Ñ.'
            ];
            
            const incomeData = [];
            const expenseData = [];
            
            // Calculate data for each month
            for (let month = 0; month < 12; month++) {
                const monthStr = `${currentYear}-${String(month + 1).padStart(2, '0')}`;
                
                const monthTransactions = appData.transactions.filter(t => t.date.startsWith(monthStr));
                
                const monthIncome = monthTransactions
                    .filter(t => t.type === 'income')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                const monthExpense = monthTransactions
                    .filter(t => t.type === 'expense')
                    .reduce((sum, t) => sum + t.amount, 0);
                
                incomeData.push(monthIncome);
                expenseData.push(monthExpense);
            }
            
            const ctx = document.getElementById('yearSummaryChart').getContext('2d');
            
            if (charts.yearSummary) {
                charts.yearSummary.destroy();
            }
            
            charts.yearSummary = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: monthNames,
                    datasets: [
                        {
                            label: '‡∏£‡∏≤‡∏¢‡∏£‡∏±‡∏ö',
                            data: incomeData,
                            borderColor: '#4caf50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#4caf50',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: '‡∏£‡∏≤‡∏¢‡∏à‡πà‡∏≤‡∏¢',
                            data: expenseData,
                            borderColor: '#f44336',
                            backgroundColor: 'rgba(244, 67, 54, 0.1)',
                            borderWidth: 3,
                            fill: false,
                            tension: 0.4,
                            pointBackgroundColor: '#f44336',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '‡∏ø' + value.toLocaleString();
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(0, 0, 0, 0.1)'
                            }
                        }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ffffff',
                            bodyColor: '#ffffff',
                            borderColor: 'rgba(255, 255, 255, 0.2)',
                            borderWidth: 1,
                            cornerRadius: 8,
                            displayColors: true,
                            callbacks: {
                                title: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const fullMonthNames = [
                                        '‡∏°‡∏Å‡∏£‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏∏‡∏°‡∏†‡∏≤‡∏û‡∏±‡∏ô‡∏ò‡πå', '‡∏°‡∏µ‡∏ô‡∏≤‡∏Ñ‡∏°', '‡πÄ‡∏°‡∏©‡∏≤‡∏¢‡∏ô', '‡∏û‡∏§‡∏©‡∏†‡∏≤‡∏Ñ‡∏°', '‡∏°‡∏¥‡∏ñ‡∏∏‡∏ô‡∏≤‡∏¢‡∏ô',
                                        '‡∏Å‡∏£‡∏Å‡∏é‡∏≤‡∏Ñ‡∏°', '‡∏™‡∏¥‡∏á‡∏´‡∏≤‡∏Ñ‡∏°', '‡∏Å‡∏±‡∏ô‡∏¢‡∏≤‡∏¢‡∏ô', '‡∏ï‡∏∏‡∏•‡∏≤‡∏Ñ‡∏°', '‡∏û‡∏§‡∏®‡∏à‡∏¥‡∏Å‡∏≤‡∏¢‡∏ô', '‡∏ò‡∏±‡∏ô‡∏ß‡∏≤‡∏Ñ‡∏°'
                                    ];
                                    return `${fullMonthNames[monthIndex]} ${currentYear + 543}`;
                                },
                                label: function(context) {
                                    const label = context.dataset.label;
                                    const value = context.parsed.y;
                                    return `${label}: ‡∏ø${value.toLocaleString()}`;
                                },
                                afterBody: function(context) {
                                    const monthIndex = context[0].dataIndex;
                                    const income = incomeData[monthIndex];
                                    const expense = expenseData[monthIndex];
                                    const balance = income - expense;
                                    const balanceText = balance >= 0 ? '‡πÄ‡∏´‡∏•‡∏∑‡∏≠' : '‡∏Ç‡∏≤‡∏î';
                                    return [``, `${balanceText}: ‡∏ø${Math.abs(balance).toLocaleString()}`];
                                }
                            }
                        },
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20,
                                font: {
                                    size: 14,
                                    family: 'Prompt'
                                }
                            }
                        }
                    },
                    elements: {
                        point: {
                            hoverBorderWidth: 3
                        }
                    }
                }
            });
        }

        // Loading overlay functions
        function showLoading() {
            $('#loadingOverlay').show();
            $('.main-content').addClass('loading').removeClass('loaded');
        }
        
        function hideLoading() {
            $('#loadingOverlay').addClass('fade-out');
            $('.main-content').removeClass('loading').addClass('loaded');
            
            setTimeout(() => {
                $('#loadingOverlay').hide().removeClass('fade-out');
            }, 500);
        }
        
        function updateLoadingStatus(message) {
            $('#loadingStatus').text(message);
        }

        // Settings
        function clearAllData() {
            Swal.fire({
                title: '‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                text: '‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÉ‡∏ä‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà? ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ',
                icon: 'warning',
                showCancelButton: true,
                confirmButtonText: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•',
                cancelButtonText: '‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å',
                confirmButtonColor: '#d33'
            }).then((result) => {
                if (!result.isConfirmed) return;

                if (isGoogleSheetsMode) {
                    Swal.fire({
                      title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...',
                      allowOutsideClick: false,
                      showConfirmButton: false
                    });

                    Swal.showLoading();
                    google.script.run
                        .withSuccessHandler(function(response) {

                            Swal.fire({
                                icon: 'success',
                                title: '‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à',
                                text: '‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß'
                            }).then(function() {
                                google.script.run.withSuccessHandler((url)=>{
                                  window.open(url,'_top')
                                }).getURL()
                            });
                        })
                        .withFailureHandler(function(error) {
                            console.error('‚ùå Error clearing data:', error);

                            Swal.fire({
                                icon: 'error',
                                title: '‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î',
                                text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏•‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á'
                            });
                        })
                        .clearAllData(); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å Apps Script
                } else {
                    // Local mode
                    localStorage.removeItem('financeApp');
                    google.script.run.withSuccessHandler((url)=>{
                      window.open(url,'_top')
                    }).getURL()
                }
            });
        }

    </script>
